<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nahla Tracker v0.4</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=VT323&display=swap">
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='80'>üåï</text></svg>">
    
    <style>
        body { 
            background-color: #1a1a1a; 
            color: #e0e0e0; 
            font-family: monospace; 
            font-size: 1.1rem; 
            line-height: 1.6; 
            padding: 20px;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        h2 {
            text-align: center;
        }
        
        #tracker { 
            padding: 20px; 
            border: 1px solid #444; 
            background-color: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center; 
        }

        #moonclock {
            font-family: "Consolas", "Courier New", monospace;
            font-size: 1.2rem;
            color: #3af2ff;
            text-shadow: 0 0 8px #3af2ff, 0 0 14px #007a85;
            text-align: center;
            margin-top: 8px;
            letter-spacing: 2px;
        }

        #moonclock-coordinated {
            font-family: "Consolas", "Courier New", monospace;
            font-size: 1.2rem;
            color: #ff61c7;
            text-shadow: 0 0 8px #ff61c7, 0 0 14px #852c66;
            text-align: center;
            margin-top: 4px;
            letter-spacing: 2px;
        }

        .time-highlight {
          color: #61dafb;
          font-weight: bold;
        }

        #notes-box {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 0 12px rgba(97, 218, 251, 0.1);
        }

        #notes-box h2 {
            color: #61dafb;
            margin-top: 0;
            margin-bottom: 10px;
            font-family: "Consolas", "Courier New", monospace;
        }

        @media (max-width: 600px) {
          #notes-box, 
          #notes-box p, 
          #notes-box div, 
          #notes-box span {
            font-size: 0.85rem !important;
            line-height: 1.45;
          }
        }

        #notes {
            background-color: #121212;
            border: 1px solid #333;
            border-radius: 6px;
            color: #ccc;
            font-family: "Inter", sans-serif;
            font-size: 0.95rem;
            padding: 8px 10px;
            line-height: 1.5;
            text-align: justify;
        }

        .gallery-container {
          cursor: grab;
        }

        .gallery-container:active {
          cursor: grabbing;
        }

        .gallery-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            height: 40px;
        }

        .gallery-header h2 {
            color: #61dafb;
            margin: 0;
            text-align: center;
            position: relative;
            top: 8px;
        }

        .gallery-btn {
            background: none;
            border: 2px solid #61dafb;
            color: #61dafb;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: monospace;
            flex-shrink: 0;
            padding: 0;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .gallery-btn:hover {
            background-color: #61dafb;
            color: #1a1a1a;
            transform: scale(1.1);
        }

        .gallery-btn:active {
            transform: scale(0.95);
        }
        
        #system-info-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        .celestial-body, #map-panel, #manifest-panel {
            flex: 1;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 0 20px 20px 20px;
            background-color: #222;
            height: 580px;
            overflow-y: auto;
        }
        
        .celestial-body h3, #map-panel h3, #manifest-panel h3 {
            color: #61dafb;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            position: sticky;
            top: 0;
            background-color: #222;
            margin: 0;
            padding-top: 20px;
        }
        
        .celestial-body ul, #map-panel ul {
            list-style-type: none;
            padding-left: 0;
            font-size: 0.9rem;
            color: #ccc;
        }
        .celestial-body li, #map-panel li {
            margin-bottom: 8px;
        }
        .celestial-body li strong, #map-panel li strong {
            color: #bbb;
        }

        #map-panel h4 {
            margin-bottom: 10px;
            color: #bbb;
        }
        
        .celestial-body::-webkit-scrollbar,
        #map-panel::-webkit-scrollbar,
        #manifest-panel::-webkit-scrollbar {
            width: 10px;
        }
        
        .celestial-body::-webkit-scrollbar-track,
        #map-panel::-webkit-scrollbar-track,
        #manifest-panel::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 4px;
        }
        
        .celestial-body::-webkit-scrollbar-thumb,
        #map-panel::-webkit-scrollbar-thumb,
        #manifest-panel::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        
        .celestial-body::-webkit-scrollbar-thumb:hover,
        #map-panel::-webkit-scrollbar-thumb:hover,
        #manifest-panel::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .manifest-list {
            list-style-type: none;
            padding-left: 0;
            font-size: 0.85rem;
        }
        .manifest-list li {
            margin-bottom: 5px;
            color: #aaa;
        }
        .manifest-list strong {
            color: #ddd;
            min-width: 40px;
            display: inline-block;
        }
        .manifest-list ul {
            list-style-type: square;
            color: #888;
            padding-left: 20px;
            margin-top: 5px;
        }

        #manifest-panel::-webkit-scrollbar {
                display: none;
        }

        #manifest-panel {
                scrollbar-width: none;
        }
 
        .hl-landable { color: #8f9; }
        .hl-terraform { color: #61dafb; font-weight: bold; }
        .hl-earthlike { color: #61fbb0; font-weight: bold; text-transform: uppercase; }
        .hl-life { color: #fbd061; font-weight: bold; }

        #gallery-section {
            margin-top: 30px;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            background-color: #2a2a2a;
        }
        
        #gallery-section h2 {
            color: #61dafb;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .gallery-container {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 10px 0;
            height: 250px;
            scroll-behavior: smooth;
        }
        
        .gallery-container::-webkit-scrollbar {
            height: 10px;
        }
        
        .gallery-container::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 4px;
        }
        
        .gallery-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        
        .gallery-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .gallery-item {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            width: 300px;
            height: 220px;
            border: 2px solid #444;
            border-radius: 8px;
            overflow: visible;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
        }

        .gallery-item img {
            width: 100%;
            height: calc(100% - 36px);
            object-fit: cover;
        }

        .gallery-caption {
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #222;
            color: #ccc;
            font-size: 0.85rem;
        }
        #map-panel img {
            width: 100%;
            max-width: 275px;
            margin-top: 35px;
            margin-left: auto;
            margin-right: auto;
            display: block;
            border-radius: 6px;
        }

        #map-panel img {
            box-shadow: 0 0 18px rgba(97, 218, 251, 0.18);
        }

        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        
        .lightbox.active {
            display: flex;
        }
        
        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(97, 218, 251, 0.3);
        }
        
        .lightbox-close {
            position: absolute;
            top: 30px;
            right: 40px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .lightbox-close:hover {
            color: #61dafb;
        }
            
        .gallery-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.95);
            color: #ddd;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s ease-out;
            margin-bottom: 6px;
            z-index: 50;
        }

        .gallery-item:hover .gallery-tooltip {
            opacity: 1;
        }

        .celestial-body::-webkit-scrollbar,
        #map-panel::-webkit-scrollbar,
        #manifest-panel::-webkit-scrollbar,
        .gallery-container::-webkit-scrollbar {
            display: none;
        }

        .celestial-body,
        #map-panel,
        #manifest-panel,
        .gallery-container {
            scrollbar-width: none;
        }

        .audio-btn {
          background: none;
          border: none;
          color: #61dafb;
          font-size: 18px;
          cursor: pointer;
          display: inline-flex;
          align-items: center;
          vertical-align: middle;
          padding: 0;
          vertical-align: 0px;
        }

        .audio-btn:active {
          transform: scale(0.9);
        }

        .orbital-debug {
            font-size: 0.85rem;
            color: #61dafb;
            margin-top: 10px;
            font-family: "Courier New", monospace;
            text-shadow: 0 0 4px rgba(97, 218, 251, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Nahla Day/Night Cycle Tracker - LIVE - v0.4 (Multi-Anchor)</h2>
        <div id="tracker">
            <div id="status">Loading...</div>
            <div id="hope">...</div>
            <div id="band">...</div>
            <div id="rebekah">...</div>
            <div id="moonclock">...</div>
            <div id="moonclock-coordinated">...</div>
            <div class="orbital-debug" id="orbital-debug">...</div>
            
            <div style="font-size: 0.9rem; color: #aaa; margin-top: 15px;">
                <a href="https://inara.cz/elite/cmdr/440263/" 
                    style="color: inherit; text-decoration: none;" 
                    target="_blank" 
                    rel="noopener noreferrer">
                    Living and studying on a remote moon since July 2025. By CMDR Lysander666 on Inara.
                </a>
            </div>
        </div>

        <h2>System Information</h2>

        <div id="system-info-container">
            
            <div class="celestial-body" id="nahla-info">
                <h3>Nahla (Moon)</h3>
                <ul>
                    <li><strong>Type:</strong> Rocky Sulphur Moon</li>
                    <li><strong>Mass:</strong> 0.0458 Earths</li>
                    <li><strong>Radius: 2,469 km</strong></li>
                    <li><strong>Atmosphere:</strong> None</li>
                    <li><strong>Gravity:</strong> 0.31 G</li>
                    <li><strong>Temp:</strong> 143 K - 275 K / -127C - 2C (Observed)</li>
                    <li><strong>Volcanism:</strong> Metallic magma, gas vents, fumaroles</li>
                    <li><strong>Orbital Period:</strong> 1.1 Earth days</li>
                    <li><strong>Rotation:</strong> 1.1 Earth days (Tidally Locked)</li>
                    <li><strong>Eccentricity:</strong> 0.0000 (Circular)</li>
                    <li><strong>Inclination:</strong> 0.00¬∞</li>
                    <li><strong>Observation post:</strong> Miley (Mandalay) at Natalja's Pass (39.2, 104.3)</li>
                    <li>
                      <strong>Nahla ambience audio:</strong>
                      <button id="audio-btn" class="audio-btn">‚ñ∂</button>
                      <audio id="nahla-audio" src="nahla-ambience.mp3"></audio>
                    </li>
                </ul>
            </div>

            <div class="celestial-body" id="rebekah-info">
                <h3>Rebekah (Parent)</h3>
                <ul>
                    <li><strong>Type:</strong> Class IV Gas Giant, ringed</li>
                    <li><strong>Mass:</strong> 3202.37 Earths</li>
                    <li><strong>Radius:</strong> 66,809 km</li>
                    <li><strong>Gravity:</strong> 29.19 G</li>
                    <li><strong>Temp:</strong> 908 K / 635C</li>
                    <li><strong>Atmosphere:</strong> H<sub>2</sub> (72.89%), He (27.11%)</li>
                    <li><strong>Distance from Primary:</strong> 2,885 ls </li>
                    <li><strong>Orbital Period:</strong> 555.2 Earth days</li>
                    <li><strong>Rotation:</strong> 0.4 Earth days</li>
                    <li><strong>Semi-major axis:</strong> 0.01 AU</li>
                    <li><strong>Eccentricity:</strong> 0.0076 (Nearly circular)</li>
                    <li><strong>Inclination:</strong> -3.69¬∞</li>
                </ul>
            </div>

            <div class="celestial-body" id="hope-info">
                <h3>Hope (Primary Star)</h3>
                <ul>
                    <li><strong>Type:</strong> A5 Vb Blue-White Star</li>
                    <li><strong>Mass:</strong> 1.6758 Solar</li>
                    <li><strong>Radius:</strong> 1.427 Solar</li>
                    <li><strong>Temp:</strong> 8,631 K / 8,358 C</li>
                    <li><strong>Absolute magnitude:</strong> 2.3165 </li>
                    <li><strong>Age:</strong> 800 million years</li>
                    <li><strong>Rotation:</strong> 1.0 Earth days</li>
                    <li><strong>&nbsp;</strong></li> <li><strong>&nbsp;</strong></li>
                </ul>
            </div>

            <div id="map-panel">
                <h3>Hypi Bra EV-P d5-78</h3>
                <ul>
                    <li><strong>Dist. to Sol:</strong> 43,895.24 ly</li>
                    <li><strong>Dist. to Colonia:</strong> 22,698.70 ly</li>
                </ul>
                <h4>Galactic Position</h4>
                <img src="galaxy_map.png" alt="Galactic Position" onclick="openLightbox('galaxy_map.png')" style="cursor: pointer;">
            </div>

            <div id="manifest-panel">
                <h3>Full System Manifest</h3>
                <ul class="manifest-list">
                   <li><strong>A</strong> Blue-White Star (Hope) (Scoopable)</li>
                    <li><strong>A Belt</strong> Rocky Belt (Bellatrix)</li>
                    <li><strong>1</strong> Metal-rich body (Simone) (3,835 K)</li>
                    <li><strong>2</strong> Class III gas giant (Marika)
                        <ul>
                            <li><strong>2a</strong> Rocky body (Abelina) <span class="hl-landable">(L)</span></li>
                            <li><strong>2b</strong> Rocky body (Jana) <span class="hl-landable">(L)</span></li>
                            <li><strong>2c</strong> Rocky body (Mira) <span class="hl-landable">(L)</span></li>
                            <li><strong>2d</strong> Rocky body (Maria) <span class="hl-landable">(L)</span>
                                <ul><li><strong>2da</strong> Rocky body (Theresa) <span class="hl-landable">(L)</span></li></ul>
                            </li>
                            <li><strong>2e</strong> Rocky body (Bunika) <span class="hl-landable">(L)</span></li>
                        </ul>
                    </li>
                    <li><strong>3</strong> High metal content (Ru≈æena) (1,077 K)</li>
                    <li><strong>4</strong> Y (Brown dwarf) Star (Rayne)
                        <ul>
                            <li><strong>4a</strong> Rocky body (Ferril) <span class="hl-landable">(L)</span></li>
                        </ul>
                    </li>
                    <li><strong>5</strong> <span class="hl-terraform">High metal content (B√°thory) (Terraform Candidate)</span></li>
                    <li><strong>6</strong> Class IV gas giant (Rebekah)
                        <ul>
                            <li><strong>6a</strong> Rocky body <span class="hl-landable">(L / Nahla)</span></li>
                            <li><strong>6b</strong> Icy body (Elena) </li>
                        </ul>
                    </li>
                    <li><strong>7</strong> <span class="hl-life">Gas giant with water-based life (Aeoga)</span>
                        <ul>
                            <li><strong>7a</strong> Rocky body (Herbst9) <span class="hl-landable">(L)</span></li>
                            <li><strong>7b</strong> Rocky body (Asmorod) <span class="hl-landable">(L)</span></li>
                            <li><strong>7c</strong> Rocky body (Troum) <span class="hl-landable">(L)</span></li>
                        </ul>
                    </li>
                    <li><strong>8</strong> <span class="hl-earthlike">*** Earth-like world *** (Ska√∞i) </span></li>
                    <li><strong>9</strong> Class IV gas giant (Draupadi)
                        <ul>
                            <li><strong>9a</strong> Rocky body (Sarasvati) <span class="hl-landable">(L)</span></li>
                            <li><strong>9b</strong> Rocky body (Gauri) <span class="hl-landable">(L)</span></li>
                            <li><strong>9c</strong> Rocky body (Chaumunda) <span class="hl-landable">(L)</span></li>
                            <li><strong>9d</strong> Rocky body (Rati) <span class="hl-landable">(L)</span>
                                <ul><li><strong>9da</strong> Rocky body (Kali) <span class="hl-landable">(L)</span></li></ul>
                            </li>
                        </ul>
                    </li>
                    <li><strong>10</strong> High metal content (Sita)</li>
                    <li><strong>11</strong> High metal content (Ariana)</li>
                    <li><strong>12</strong> High metal content (Anneke)</li>
                </ul>
            </div>
            
        </div>

        <div id="gallery-section">
            <div class="gallery-header">
                <button class="gallery-btn" id="scroll-left">&lt;</button>
                <h2>Gallery</h2>
                <button class="gallery-btn" id="scroll-right">&gt;</button>
            </div>
            <div class="gallery-container">
                <div class="gallery-item" onclick="openLightbox('Nahla.jpg')">
                    <div class="gallery-tooltip">Nahla</div>
                    <img src="Nahla.jpg" alt="Nahla">
                    <div class="gallery-caption">Nahla</div>
                </div>             

                <div class="gallery-item" onclick="openLightbox('Rebekah-from-Nahla.jpg')">
                    <div class="gallery-tooltip">Rebekah seen from Nahla</div>
                    <img src="Rebekah-from-Nahla.jpg" alt="Rebekah seen from Nahla">
                    <div class="gallery-caption">Rebekah seen from Nahla</div>
                </div>
                         
                <div class="gallery-item" onclick="openLightbox('Pate-Sablee-Overhead.jpg')">
                    <div class="gallery-tooltip">P√¢te Sabl√©e crater</div>
                    <img src="Pate-Sablee-Overhead.jpg" alt="P√¢te Sabl√©e crater">
                    <div class="gallery-caption">P√¢te Sabl√©e crater</div>
                </div>     

                <div class="gallery-item" onclick="openLightbox('galactic-band.jpg')">
                    <div class="gallery-tooltip">Galactic band</div>
                    <img src="galactic-band.jpg" alt="Galactic band">
                    <div class="gallery-caption">Galactic band</div>
                </div>
                    
                <div class="gallery-item" onclick="openLightbox('Natalja.jpg')">
                    <div class="gallery-tooltip">Natalja's Pass</div>
                    <img src="Natalja.jpg" alt="Natalja's Pass">
                    <div class="gallery-caption">Natalja's Pass</div>
                </div>

                <div class="gallery-item" onclick="openLightbox('night.jpg')">
                    <div class="gallery-tooltip">True Night</div>
                    <img src="night.jpg" alt="Night">
                    <div class="gallery-caption">True Night</div>
                </div>

                <div class="gallery-item" onclick="openLightbox('galacticnight.jpg')">
                    <div class="gallery-tooltip">Galactic Night</div>
                    <img src="galacticnight.jpg" alt="Galactic Night">
                    <div class="gallery-caption">Galactic Night</div>
                </div>         
                    
                <div class="gallery-item" onclick="openLightbox('hope.jpg')">
                    <div class="gallery-tooltip">Hope</div>
                    <img src="hope.jpg" alt="Hope">
                    <div class="gallery-caption">Hope</div>
                </div>
                
                 <div class="gallery-item" onclick="openLightbox('sunset.jpg')">
                    <div class="gallery-tooltip">Sunset</div>
                    <img src="sunset.jpg" alt="Sunset">
                    <div class="gallery-caption">Sunset</div>
                </div>          
            </div>
        </div>

        <div class="lightbox" id="lightbox" onclick="closeLightbox()">
            <span class="lightbox-close">&times;</span>
            <img id="lightbox-image" src="" alt="Enlarged view">
        </div>

        <div id="notes-box">
            <h2>Notes</h2>
            <div id="notes">
                <p><strong>v0.4 Update:</strong> Now using proper orbital mechanics with EDSM data. The tracker accounts for Rebekah's motion around Hope and uses Keplerian orbital calculations for more accurate predictions.
                <p>Multi-anchor observation system included. Now tracking Hope sunrise/sunset and Rebekah rise/set separately for improved accuracy. Adding more observations to reduce drift over time.</p>
                <p><em>Clarification:</em> Nahla Coordinated time [NCT] isn't truly 24 Earth hours. It's a compressed version of Nahla's 26h 24m solar day, scaled for reference and context. 
Every NCT 'second' lasts roughly 1.1 Earth seconds. Here we live by GMT. </p>
                <br>
                Day‚Äìnight cycles beyond Earth vary according to the orbital and rotational dynamics of their respective worlds, rather than adhering to Earth's 24-hour rhythm.
                <p></p>
                <small>Nahla Tracker is a personal project of Lysander666.</small>
            </div>
        </div>

    </div>

    <script>
        // ===== ORBITAL DATA FROM EDSM =====
        const ORBITAL_DATA = {
            rebekah: {
                semiMajorAxis: 0.01,  // AU
                eccentricity: 0.0076,
                inclination: -3.69,    // degrees
                argOfPeriapsis: 72.92, // degrees
                period: 555.2          // Earth days
            },
            nahla: {
                semiMajorAxis: 4.794e-5, // AU (calculated from period and Rebekah's mass)
                eccentricity: 0.0000,
                inclination: 0.00,
                argOfPeriapsis: 80.09,
                period: 1.1               // Earth days
            }
        };

        // ===== OBSERVATION ANCHORS =====
        // Add timestamps as you observe them!
        // Format options:
        //   Simple: "YYYY-MM-DDTHH:MM:SS"
        //   With confidence: { time: "YYYY-MM-DDTHH:MM:SS", confidence: "high" }
        //   Confidence levels: "high" (default), "medium", "low", "estimate"
        
        const HOPE_SUNRISE_OBS = [
            { time: "2025-11-09T20:00:00", confidence: "medium" }
            // Add more Hope sunrise observations here
            // Examples:
            // "2025-11-10T20:05:00",  // Simple format (assumed high confidence)
            // { time: "2025-11-11T20:03:00", confidence: "medium" }
        ];

        const HOPE_SUNSET_OBS = [
            // Add Hope sunset observations here
            { time: "2025-11-16T23:25:00", confidence: "high" }
        ];

        const REBEKAH_RISE_OBS = [
            { time: "2025-11-09T21:30:00", confidence: "low" }, // <- comma here!
            { time: "2025-11-16T10:30:00", confidence: "medium" }
            // Add more Rebekah rise observations here
        ];

        const REBEKAH_SET_OBS = [
            // Add Rebekah set observations here
            { time: "2025-11-16T21:00:00", confidence: "high" }
        ];

        const GALACTIC_VERTICAL_OBS = [
            { time: "2025-11-15T15:00:00", confidence: "high" },
            { time: "2025-11-16T16:00:00", confidence: "high" }

            // Add more galactic band reference observations if needed
        ];

        // ===== HELPER FUNCTIONS =====
        
        // Normalize observation to object format
        function normalizeObs(obs) {
            if (typeof obs === 'string') {
                return { time: obs, confidence: 'high' };
            }
            return { time: obs.time, confidence: obs.confidence || 'high' };
        }
        
        // Get confidence weight (higher = more reliable)
        function getConfidenceWeight(confidence) {
            const weights = {
                'high': 1.0,
                'medium': 0.7,
                'low': 0.4,
                'estimate': 0.2
            };
            return weights[confidence] || 1.0;
        }
        
        function toDates(list) {
            return list.map(obs => {
                const normalized = normalizeObs(obs);
                return { date: new Date(normalized.time), confidence: normalized.confidence };
            });
        }

        function averagePeriod(list) {
            if (list.length < 2) return null;
            const observations = toDates(list).sort((a, b) => a.date - b.date);
            
            let totalWeightedDiff = 0;
            let totalWeight = 0;
            
            for (let i = 1; i < observations.length; i++) {
                const diff = observations[i].date - observations[i - 1].date;
                const weight = Math.min(
                    getConfidenceWeight(observations[i].confidence),
                    getConfidenceWeight(observations[i - 1].confidence)
                );
                totalWeightedDiff += diff * weight;
                totalWeight += weight;
            }
            
            return totalWeight > 0 ? totalWeightedDiff / totalWeight : null;
        }

        function anchor(list) {
            if (list.length === 0) return null;
            const observations = toDates(list);
            return observations.reduce((earliest, obs) => 
                obs.date < earliest.date ? obs : earliest
            ).date;
        }

        function mostRecent(list) {
            if (list.length === 0) return null;
            const observations = toDates(list);
            // Prefer high confidence recent observations
            const sorted = observations.sort((a, b) => {
                const timeDiff = b.date - a.date;
                if (Math.abs(timeDiff) < 3600000) { // Within 1 hour
                    return getConfidenceWeight(b.confidence) - getConfidenceWeight(a.confidence);
                }
                return timeDiff;
            });
            return sorted[0].date;
        }

        // ===== ORBITAL MECHANICS FUNCTIONS =====
        
        // Convert degrees to radians
        function degToRad(deg) {
            return deg * Math.PI / 180;
        }

        // Solve Kepler's equation for eccentric anomaly (iterative)
        function solveKepler(meanAnomaly, eccentricity, tolerance = 1e-6) {
            let E = meanAnomaly;
            let delta = 1;
            let iterations = 0;
            const maxIterations = 100;
            
            while (Math.abs(delta) > tolerance && iterations < maxIterations) {
                delta = E - eccentricity * Math.sin(E) - meanAnomaly;
                E = E - delta / (1 - eccentricity * Math.cos(E));
                iterations++;
            }
            
            return E;
        }

        // Calculate true anomaly from eccentric anomaly
        function trueAnomalyFromEccentric(E, e) {
            return 2 * Math.atan2(
                Math.sqrt(1 + e) * Math.sin(E / 2),
                Math.sqrt(1 - e) * Math.cos(E / 2)
            );
        }

        // Get orbital position at given time
        function getOrbitalPosition(body, epochTime, currentTime) {
            const periodMs = body.period * 86400 * 1000;
            const timeSinceEpoch = (currentTime - epochTime) / 1000;
            const meanMotion = (2 * Math.PI) / (body.period * 86400);
            
            const M = (meanMotion * timeSinceEpoch) % (2 * Math.PI);
            const E = solveKepler(M, body.eccentricity);
            const nu = trueAnomalyFromEccentric(E, body.eccentricity);
            const r = body.semiMajorAxis * (1 - body.eccentricity * Math.cos(E));
            const u = nu + degToRad(body.argOfPeriapsis);
            
            return {
                trueAnomaly: nu,
                distance: r,
                argumentOfLatitude: u,
                meanAnomaly: M,
                eccentricAnomaly: E
            };
        }

        // ===== CALIBRATED PERIODS AND ANCHORS =====
        
        // Calculate Hope's day/night period from sunrise observations
        const hopeSolarDayMs = averagePeriod(HOPE_SUNRISE_OBS) || (1.1 * 86400 * 1000);
        const HOPE_SOLAR_DAY_SECONDS = hopeSolarDayMs / 1000;
        
        // Use most recent Hope sunrise as primary anchor
        const HOPE_LAST_SUNRISE = mostRecent(HOPE_SUNRISE_OBS) || anchor(HOPE_SUNRISE_OBS);
        const HOPE_LAST_SUNSET = mostRecent(HOPE_SUNSET_OBS);
        
        // ===== Calculate Rebekah's True Libration Period =====
        // We know there are 6 libration cycles between our first two 'rise' observations.
        // (From 2025-11-09 21:30 to 2025-11-16 10:30 is 157 hours, / 26.17h period ‚âà 6 cycles)
        
        const REBEKAH_PERIOD_CALC_MS = (new Date("2025-11-16T10:30:00") - new Date("2025-11-09T21:30:00")) / 6;
        
        // This is our new, accurate libration period
        const REBEKAH_LIB_PERIOD_SECONDS = REBEKAH_PERIOD_CALC_MS / 1000; // Should be ~94200 seconds or 26.17 hours

        // ===== Calculate Asymmetric Libration Cycle =====
        const REBEKAH_LAST_RISE = mostRecent(REBEKAH_RISE_OBS);
        const REBEKAH_LAST_SET = mostRecent(REBEKAH_SET_OBS);

        let DURATION_REBEKAH_VISIBLE_SECONDS = 0;
        let DURATION_REBEKAH_HIDDEN_SECONDS = 0;

        if (REBEKAH_LAST_RISE && REBEKAH_LAST_SET) {
            // Calculate time between the most recent rise and set
            let visible_duration = (REBEKAH_LAST_SET - REBEKAH_LAST_RISE) / 1000;
            
            // Ensure it's positive (e.g., if last rise is *after* last set)
            if (visible_duration < 0) {
                 // This means the set belongs to the *previous* rise, so we add one period
                 visible_duration += REBEKAH_LIB_PERIOD_SECONDS;
            }

            DURATION_REBEKAH_VISIBLE_SECONDS = visible_duration;
            DURATION_REBEKAH_HIDDEN_SECONDS = REBEKAH_LIB_PERIOD_SECONDS - DURATION_REBEKAH_VISIBLE_SECONDS;
        }

        const SIDEREAL_DAY_SECONDS = (averagePeriod(GALACTIC_VERTICAL_OBS) / 1000) || 90000;        
        const GALACTIC_BAND_VERTICAL = mostRecent(GALACTIC_VERTICAL_OBS);

        // ===== CONSTANTS =====
        const MOON_NAME = "Nahla";
        const SECONDS_IN_EARTH_DAY = 86400;

        // ===== DISPLAY FUNCTIONS =====
        
        function format_timedelta(total_seconds) {
            const hours = Math.floor(total_seconds / 3600);
            const minutes = Math.floor((total_seconds % 3600) / 60);
            const seconds = Math.floor(total_seconds % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

 function get_hope_status(current_time) {
            if (!HOPE_LAST_SUNRISE) {
                return { status: "<strong>Hope:</strong> Awaiting sunrise observation", arc: "", isDaytime: false, progress: 0 };
            }

            // Determine current state.
            let is_daytime = true; // Default to true if we only have rise data
            if (HOPE_LAST_SUNSET) { // This is the new, smart check
                // If the last rise is more recent than the last set, it's daytime.
                is_daytime = HOPE_LAST_SUNRISE > HOPE_LAST_SUNSET;
            }

            // We are still *estimating* a 50/50 split for the countdown,
            // but the *state* (day/night) will now be 100% correct.
            const half_day = HOPE_SOLAR_DAY_SECONDS / 2;
            
            if (is_daytime) {
                // State is DAY. Next event is SET.
                const time_since_rise = (current_time - HOPE_LAST_SUNRISE) / 1000;
                // Calculate progress based on the *full* cycle
                const current_cycle_seconds = ((time_since_rise % HOPE_SOLAR_DAY_SECONDS) + HOPE_SOLAR_DAY_SECONDS) % HOPE_SOLAR_DAY_SECONDS;
                const time_until_sunset = half_day - current_cycle_seconds;

                // --- Build the arc ---
                const progress = current_cycle_seconds / half_day;
                const positions = ["üåÖ", "‚òÄÔ∏è", "‚òÄÔ∏è", "‚òÄÔ∏è", "‚òÄÔ∏è", "üåá"];
                const index = Math.floor(progress * (positions.length - 1));
                let arc = ["‚îÄ", "‚îÄ", "‚îÄ", "‚îÄ", "‚îÄ", "‚îÄ"];
                arc[index] = positions[index];
                
                return {
                    status: `‚òÄÔ∏è  DAY on ${MOON_NAME} | Sunset in: <span class="time-highlight">${format_timedelta(time_until_sunset)}</span>`,
                    arc: `<strong>Hope:</strong> [${arc.join("")}]`,
                    isDaytime: true,
                    progress: current_cycle_seconds / HOPE_SOLAR_DAY_SECONDS
                };

            } else {
                // State is NIGHT. Next event is RISE.
                const time_since_set = (current_time - HOPE_LAST_SUNSET) / 1000;
                // Calculate progress based on the *full* cycle
                const current_cycle_seconds = ((time_since_set % HOPE_SOLAR_DAY_SECONDS) + HOPE_SOLAR_DAY_SECONDS) % HOPE_SOLAR_DAY_SECONDS;
                const time_until_sunrise = half_day - current_cycle_seconds;

                return {
                    status: `üåô NIGHT on ${MOON_NAME} | Sunrise in: <span class="time-highlight">${format_timedelta(time_until_sunrise)}</span>`,
                    arc: `<strong>Hope:</strong> [‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ] (below horizon)`,
                    isDaytime: false,
                    progress: (half_day + current_cycle_seconds) / HOPE_SOLAR_DAY_SECONDS // Night progress
                };
            }
        }

function get_rebekah_status(current_time) {
            // Check if we have all the data needed
            if (!REBEKAH_LAST_RISE || !REBEKAH_LAST_SET || DURATION_REBEKAH_VISIBLE_SECONDS === 0) {
                return `<strong>Rebekah:</strong> Awaiting rise AND set observations to calibrate cycle...`;
            }
            
            // Find our current position in the ~26.17 hour libration cycle
            const time_since_rise = (current_time - REBEKAH_LAST_RISE) / 1000;
            const current_cycle_seconds = ((time_since_rise % REBEKAH_LIB_PERIOD_SECONDS) + REBEKAH_LIB_PERIOD_SECONDS) % REBEKAH_LIB_PERIOD_SECONDS;

            // NEW ASYMMETRIC LOGIC:
            if (current_cycle_seconds < DURATION_REBEKAH_VISIBLE_SECONDS) {
                // We are in the "VISIBLE" part of the cycle
                const time_until_set = DURATION_REBEKAH_VISIBLE_SECONDS - current_cycle_seconds;
                return `<strong>Rebekah:</strong> ü™ê VISIBLE | Est. set in: <span class="time-highlight">${format_timedelta(time_until_set)}</span>`;
            
            } else {
                // We are in the "HIDDEN" part of the cycle
                const time_until_rise = REBEKAH_LIB_PERIOD_SECONDS - current_cycle_seconds;
                return `<strong>Rebekah:</strong> ‚îÄ below horizon | Est. rise in: <span class="time-highlight">${format_timedelta(time_until_rise)}</span>`;
            }
        }
        
        
        
        }

        function get_galactic_band_indicator(current_time) {
            if (!GALACTIC_BAND_VERTICAL) {
        return `<strong>Galactic Band:</strong> üåå Awaiting reference observation`;
    }
    
    const time_since_vertical = (current_time - GALACTIC_BAND_VERTICAL) / 1000;
    // THE FIX: Use the new constant
    const current_cycle_seconds = ((time_since_vertical % SIDEREAL_DAY_SECONDS) + SIDEREAL_DAY_SECONDS) % SIDEREAL_DAY_SECONDS;
    
    // THE FIX: Use the new constant
    const degrees_per_second = 360 / SIDEREAL_DAY_SECONDS;
    const current_angle = (90 + (current_cycle_seconds * degrees_per_second)) % 360;
    
    return `<strong>Galactic Band:</strong> üåå at <span class="time-highlight">${current_angle.toFixed(1)}¬∞</span> (from 90¬∞ vertical reference)`;
}

        function get_moon_clock() {
            if (!HOPE_LAST_SUNRISE) return "Nahla Local Time: Awaiting sunrise observation";
            
            const now_ms = Date.now();
            const time_since_sunrise = (now_ms - HOPE_LAST_SUNRISE) / 1000; 
            const current_cycle_seconds = time_since_sunrise % HOPE_SOLAR_DAY_SECONDS;

            const hours = Math.floor(current_cycle_seconds / 3600);
            const minutes = Math.floor((current_cycle_seconds % 3600) / 60);
            const seconds = Math.floor(current_cycle_seconds % 60);
            const ms = Math.floor((Date.now() % 1000) / 10);

            return `Nahla Local Time: ${String(hours).padStart(2, '0')}:` +
                   `${String(minutes).padStart(2, '0')}:` +
                   `${String(seconds).padStart(2, '0')}.` +
                   `${String(ms).padStart(2, '0')} (out of 26:24:00)`;
        }

        function get_nahla_coordinated_time() {
            if (!HOPE_LAST_SUNRISE) return "Nahla Coordinated Time: Awaiting sunrise observation";
            
            const now_ms = Date.now();
            const time_since_sunrise = (now_ms - HOPE_LAST_SUNRISE) / 1000;
            const current_cycle_seconds = time_since_sunrise % HOPE_SOLAR_DAY_SECONDS;

            const SCALE = 24 / 26.4;
            const scaled_seconds = current_cycle_seconds * SCALE;

            const hours = Math.floor(scaled_seconds / 3600);
            const minutes = Math.floor((scaled_seconds % 3600) / 60);
            const seconds = Math.floor(scaled_seconds % 60);
            const fractional = scaled_seconds % 1;
            const ms = Math.floor(fractional * 100);

            return `Nahla Coordinated Time: ${String(hours).padStart(2, '0')}:` +
                   `${String(minutes).padStart(2, '0')}:` +
                   `${String(seconds).padStart(2, '0')}.` +
                   `${String(ms).padStart(2, '0')} (out of 24:00:00)`;
        }

        function getOrbitalDebugInfo() {
            if (!HOPE_LAST_SUNRISE) return "Orbital: Awaiting observations";
            
            const now = new Date();
            const nahlaPos = getOrbitalPosition(ORBITAL_DATA.nahla, HOPE_LAST_SUNRISE, now);
            const rebekahPos = getOrbitalPosition(ORBITAL_DATA.rebekah, HOPE_LAST_SUNRISE, now);
            
            // const obsCount = HOPE_SUNRISE_OBS.length + HOPE_SUNSET_OBS.length + 
            //                REBEKAH_RISE_OBS.length + REBEKAH_SET_OBS.length;
            
            return `Orbital: Nahla ŒΩ=${(nahlaPos.trueAnomaly * 180 / Math.PI).toFixed(1)}¬∞ | ` +
                   `Rebekah ŒΩ=${(rebekahPos.trueAnomaly * 180 / Math.PI).toFixed(1)}¬∞ | ` +
                   `Rebekah phase: ${((rebekahPos.meanAnomaly / (2 * Math.PI)) * 100).toFixed(2)}%`;
                   // + ` | ${obsCount} observations logged`;
        }

        // ===== MAIN UPDATE LOOP =====
        function updateDisplay() {
            const current_time = new Date();
            const hopeStatus = get_hope_status(current_time);
            
            if (hopeStatus.status) {
                const hours_into_day = hopeStatus.progress * (HOPE_SOLAR_DAY_SECONDS / 3600);
                document.getElementById("status").innerHTML = 
                    hopeStatus.status + ` | <span class="time-highlight">${hours_into_day.toFixed(2)}h</span> into solar day`;
                document.getElementById("hope").innerHTML = hopeStatus.arc;
            } else {
                document.getElementById("status").innerHTML = hopeStatus;
                document.getElementById("hope").innerHTML = "";
            }
            
            document.getElementById("band").innerHTML = get_galactic_band_indicator(current_time);
            document.getElementById("rebekah").innerHTML = get_rebekah_status(current_time);
            document.getElementById("orbital-debug").innerHTML = getOrbitalDebugInfo();
        }

        // Run updates
        updateDisplay();
        setInterval(updateDisplay, 1000);
        
        setInterval(() => {
            document.getElementById('moonclock').textContent = get_moon_clock();
            document.getElementById('moonclock-coordinated').textContent = get_nahla_coordinated_time();
        }, 50);

        // ===== GALLERY FUNCTIONS =====
        function openLightbox(imageSrc) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            lightboxImage.src = imageSrc;
            lightbox.classList.add('active');
        }
        
        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.remove('active');
        }
        
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeLightbox();
            }
        });

        // Gallery draggable
        const gallery = document.querySelector('.gallery-container');
        let isDown = false;
        let startX;
        let scrollLeft;

        gallery.addEventListener('mousedown', (e) => {
            isDown = true;
            gallery.classList.add('active');
            startX = e.pageX - gallery.offsetLeft;
            scrollLeft = gallery.scrollLeft;
        });

        gallery.addEventListener('mouseleave', () => {
            isDown = false;
        });

        gallery.addEventListener('mouseup', () => {
            isDown = false;
        });

        gallery.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - gallery.offsetLeft;
            const walk = (x - startX) * 1.3;
            gallery.scrollLeft = scrollLeft - walk;
        });

        const scrollLeftBtn = document.getElementById('scroll-left');
        const scrollRightBtn = document.getElementById('scroll-right');
        const scrollAmount = 630;

        scrollLeftBtn.addEventListener('click', () => {
            gallery.scrollBy({
                left: -scrollAmount,
                behavior: 'smooth'
            });
        });

        scrollRightBtn.addEventListener('click', () => {
            gallery.scrollBy({
                left: scrollAmount,
                behavior: 'smooth'
            });
        });

        // Audio player
        const audio = document.getElementById("nahla-audio");
        const btn = document.getElementById("audio-btn");

        btn.addEventListener("click", () => {
            if (audio.paused) {
                audio.play();
                btn.textContent = "‚è∏";
            } else {
                audio.pause();
                btn.textContent = "‚ñ∂";
            }
        });
    </script>
</body>
</html>
