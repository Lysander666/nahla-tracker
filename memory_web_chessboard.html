<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Web Chessboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%236366f1%22/><rect width=%2250%22 height=%2250%22 fill=%22rgba(255,255,255,0.4)%22/><rect x=%2250%22 y=%2250%22 width=%2250%22 height=%2250%22 fill=%22rgba(255,255,255,0.4)%22/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains+Mono', monospace; }
        
        .tile-light { background-color: rgba(255, 255, 255, 0.12); border-color: rgba(255, 255, 255, 0.05); }
        .tile-dark { background-color: rgba(0, 0, 0, 0.4); border-color: rgba(0, 0, 0, 0.2); }
        
        .number-glow { text-shadow: 0 0 12px rgba(255,255,255,0.4), 0 0 2px rgba(0,0,0,0.8); }
        .endpoint-glow { text-shadow: 0 0 20px rgba(255,255,255,0.6); }

        .node-button { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .timer-bar { transition: width 100ms linear; }

        .cluster-input {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: white; text-align: center; font-size: 3rem; font-weight: 900;
            width: 80px; height: 80px; border-radius: 1rem; outline: none;
        }

        .chessboard-container { transition: opacity 0.8s ease-in-out, filter 0.8s ease-in-out; }

        .chess-piece {
            font-size: 2.5rem;
            cursor: pointer;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
            user-select: none;
        }
        .chess-piece.white { color: #fff; }
        .chess-piece.black { color: #6366f1; } /* Indigo for AI */

        @keyframes piece-pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-piece { animation: piece-pop 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- FIREBASE CONFIG ---
        const isCanvasEnv = typeof __firebase_config !== 'undefined';
        const myProductionConfig = {
            apiKey: "AIzaSyCCAMapMCPHeXUvmR0DF4ERl8ay58Rz37w",
            authDomain: "thesis-memory-web.firebaseapp.com",
            projectId: "thesis-memory-web",
            storageBucket: "thesis-memory-web.firebasestorage.app",
            messagingSenderId: "1000243001742",
            appId: "1:1000243001742:web:e367ebe8af3f6dcef14cdf"
        };
        const firebaseConfig = isCanvasEnv ? JSON.parse(__firebase_config) : myProductionConfig;
        const platformAppId = isCanvasEnv ? (typeof __app_id !== 'undefined' ? __app_id : 'thesis-memory-web') : 'production';

        const firebase = window.firebase;
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- CHESS PIECE MAPPING ---
        const PIECES = {
            wP: '♙', wN: '♘', wB: '♗', wR: '♖', wQ: '♕', wK: '♔',
            bP: '♟', bN: '♞', bB: '♝', bR: '♜', bQ: '♛', bK: '♚'
        };

        const Icon = ({ name, size = 16, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    const kebabName = name.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase().replace(/^-/, '');
                    i.setAttribute('data-lucide', kebabName);
                    if (className) i.setAttribute('class', className);
                    i.style.width = size + 'px'; i.style.height = size + 'px';
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons();
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="flex items-center justify-center shrink-0" />;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [rowColors, setRowColors] = useState(['emerald', 'emerald', 'blue', 'blue', 'purple', 'purple', 'amber', 'amber']);
            const [testMode, setTestMode] = useState(false);
            const [chessMode, setChessMode] = useState(false);
            const [targetNode, setTargetNode] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [stats, setStats] = useState({ correct: 0, total: 0 });
            const [saveStatus, setSaveStatus] = useState('synced');
            const [isFinished, setIsFinished] = useState(false);
            
            // Drill/Chess State
            const [timeLeft, setTimeLeft] = useState(5000); 
            const [userInput, setUserInput] = useState('');
            const [game, setGame] = useState(new Chess());
            const [selectedSquare, setSelectedSquare] = useState(null);
            const [moveHistory, setMoveHistory] = useState([]);
            
            const inputRef = useRef(null);
            const timerRef = useRef(null);

            useEffect(() => {
                const performAuth = async () => {
                    try {
                        if (isCanvasEnv && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else if (!auth.currentUser) {
                            await auth.signInAnonymously();
                        }
                    } catch (err) { console.error(err); }
                };
                performAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => setUser(u));
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const docRef = isCanvasEnv 
                    ? db.collection('artifacts').doc(platformAppId).collection('users').doc(user.uid).collection('state').doc('trainerConfig')
                    : db.collection('thesis_data').doc(platformAppId).collection('users').doc(user.uid).collection('trainer').doc('config');
                
                const unsubscribe = docRef.onSnapshot((docSnap) => {
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        if (data.rowColors) setRowColors(data.rowColors);
                    }
                });
                return () => unsubscribe();
            }, [user]);

            const updateRowColor = async (rowIndex, color) => {
                const newColors = [...rowColors];
                newColors[rowIndex] = color;
                setRowColors(newColors);
                if (!user) return;
                setSaveStatus('saving');
                try {
                    const docRef = isCanvasEnv 
                        ? db.collection('artifacts').doc(platformAppId).collection('users').doc(user.uid).collection('state').doc('trainerConfig')
                        : db.collection('thesis_data').doc(platformAppId).collection('users').doc(user.uid).collection('trainer').doc('config');
                    await docRef.set({ rowColors: newColors, lastUpdated: new Date().toISOString() }, { merge: true });
                    setSaveStatus('synced');
                } catch (err) { setSaveStatus('error'); }
            };

            // --- DRILL LOGIC ---
            const toggleDrill = () => {
                setChessMode(false);
                if (testMode) {
                    setTestMode(false);
                    setTargetNode(null);
                    setStats({ correct: 0, total: 0 });
                    setIsFinished(false);
                } else {
                    setStats({ correct: 0, total: 0 });
                    setIsFinished(false);
                    setTestMode(true);
                    startNextNode();
                }
            };

            const startNextNode = () => {
                const randomNode = Math.floor(Math.random() * 64) + 1;
                setTargetNode(randomNode);
                setFeedback(null);
                setTimeLeft(5000);
                setUserInput('');
                setTimeout(() => inputRef.current?.focus(), 100);
            };

            useEffect(() => {
                if (testMode && targetNode && timeLeft > 0 && !feedback && !isFinished) {
                    timerRef.current = setTimeout(() => setTimeLeft(prev => prev - 100), 100);
                } else if (timeLeft <= 0 && !feedback && testMode && !isFinished) {
                    handleOutcome(false, "TIME OUT!");
                }
                return () => clearTimeout(timerRef.current);
            }, [testMode, targetNode, timeLeft, feedback, isFinished]);

            const handleOutcome = (success, msg) => {
                const correctCluster = Math.ceil(targetNode / 8);
                const newTotal = stats.total + 1;
                setStats(prev => ({ ...prev, correct: success ? prev.correct + 1 : prev.correct, total: newTotal }));
                setFeedback({ success, message: success ? "ACCURATE." : `${msg} Cluster was ${correctCluster}.` });
                if (newTotal >= 8) setTimeout(() => setIsFinished(true), 1500);
                else setTimeout(startNextNode, success ? 1000 : 2000);
            };

            // --- CHESS LOGIC ---
            const makeAMove = (move) => {
                const gameCopy = new Chess(game.fen());
                const result = gameCopy.move(move);
                if (result) {
                    setGame(gameCopy);
                    setMoveHistory(gameCopy.history());
                    return true;
                }
                return false;
            };

            const makeRandomMove = () => {
                const possibleMoves = game.moves();
                if (game.game_over() || game.in_draw() || possibleMoves.length === 0) return;
                const randomIndex = Math.floor(Math.random() * possibleMoves.length);
                makeAMove(possibleMoves[randomIndex]);
            };

            const onSquareClick = (square) => {
                if (!chessMode) return;
                if (selectedSquare === null) {
                    const piece = game.get(square);
                    if (piece && piece.color === 'w') setSelectedSquare(square);
                } else {
                    const move = makeAMove({ from: selectedSquare, to: square, promotion: 'q' });
                    setSelectedSquare(null);
                    if (move) setTimeout(makeRandomMove, 500);
                }
            };

            const getChessSquareName = (r, c) => {
                const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
                const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
                return files[c] + ranks[r];
            };

            const colorClasses = {
                emerald: 'border-emerald-500/60 text-emerald-300 ring-emerald-500/30 shadow-[inset_0_0_30px_rgba(16,185,129,0.15)]',
                amber: 'border-amber-500/60 text-amber-300 ring-amber-500/30 shadow-[inset_0_0_30px_rgba(245,158,11,0.15)]',
                blue: 'border-blue-500/60 text-blue-300 ring-blue-500/30 shadow-[inset_0_0_30px_rgba(59,130,246,0.15)]',
                purple: 'border-purple-500/60 text-purple-300 ring-purple-500/30 shadow-[inset_0_0_30px_rgba(168,85,247,0.15)]'
            };

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center selection:bg-indigo-500 selection:text-white">
                    <div className="max-w-6xl w-full">
                        <header className="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
                            <div className="flex items-center gap-5">
                                <div className="w-14 h-14 bg-indigo-600 rounded-3xl flex items-center justify-center shadow-2xl shadow-indigo-600/40 border-t border-white/20">
                                    <Icon name="ShieldCheck" size={32} className="text-white" />
                                </div>
                                <div>
                                    <div className="flex items-center gap-3">
                                        <h1 className="text-3xl font-black tracking-tight uppercase italic leading-none mb-1">Thesis Tactical Web</h1>
                                        <a href="thesis-memory-web.html" className="text-[10px] bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-1 rounded-full text-slate-400 font-bold flex items-center gap-1.5 transition-all">
                                            <Icon name="ArrowLeft" size={10} /> Back to Web
                                        </a>
                                    </div>
                                    <p className="text-slate-500 text-[10px] font-black tracking-[0.4em] uppercase">Multi-Mode Combat Simulator</p>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <button 
                                    onClick={() => { setChessMode(!chessMode); setTestMode(false); }}
                                    className={`flex items-center gap-2 px-6 py-3 rounded-2xl text-xs font-black uppercase tracking-widest transition-all ${chessMode ? 'bg-indigo-500 text-white shadow-lg' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                                >
                                    <Icon name="Sword" size={16} />
                                    {chessMode ? 'Chess Combat Active' : 'Chess Combat'}
                                </button>
                                <button 
                                    onClick={toggleDrill}
                                    className={`flex items-center gap-2 px-6 py-3 rounded-2xl text-xs font-black uppercase tracking-widest transition-all ${testMode ? 'bg-red-500/10 text-red-400 border border-red-500/30' : 'bg-white text-indigo-900 shadow-xl'}`}
                                >
                                    <Icon name={testMode ? "XCircle" : "Zap"} size={16} />
                                    {testMode ? 'Abort Sprint' : 'Memory Sprint'}
                                </button>
                            </div>
                        </header>

                        <div className="grid lg:grid-cols-[1fr_360px] gap-12">
                            {/* Main Board Container */}
                            <div className={`bg-slate-900/40 p-1.5 rounded-[3.5rem] border border-white/5 shadow-2xl chessboard-container ${testMode && !isFinished ? 'opacity-10 grayscale' : 'opacity-100'}`}>
                                <div className="p-4 bg-black/60 rounded-[3rem] border border-white/10 relative overflow-hidden">
                                    <div className="grid grid-rows-8 gap-1.5 relative z-10">
                                        {rowColors.map((color, rIdx) => (
                                            <div key={rIdx} className="grid grid-cols-8 gap-1.5">
                                                {Array.from({ length: 8 }).map((_, cIdx) => {
                                                    const nodeNum = (rIdx * 8) + cIdx + 1;
                                                    const sqName = getChessSquareName(rIdx, cIdx);
                                                    const piece = game.get(sqName);
                                                    const isEndpoint = nodeNum % 8 === 0;
                                                    const isLightTile = (rIdx + cIdx) % 2 === 0;
                                                    const isSelected = selectedSquare === sqName;

                                                    return (
                                                        <div
                                                            key={cIdx}
                                                            onClick={() => onSquareClick(sqName)}
                                                            className={`
                                                                aspect-square rounded-xl border-2 flex flex-col items-center justify-center node-button relative overflow-hidden
                                                                ${isLightTile ? 'tile-light' : 'tile-dark'}
                                                                ${colorClasses[color]}
                                                                ${isSelected ? 'ring-4 ring-indigo-500 bg-indigo-500/20' : ''}
                                                                ${testMode && nodeNum === targetNode ? 'ring-[6px] ring-white animate-pulse' : ''}
                                                                ${chessMode ? 'cursor-pointer hover:brightness-125' : 'cursor-default'}
                                                            `}
                                                        >
                                                            {/* Background Node Number */}
                                                            <span className={`absolute top-1 left-1.5 text-[10px] font-mono font-black opacity-20 ${isEndpoint ? 'opacity-40' : ''}`}>
                                                                {nodeNum}
                                                            </span>

                                                            {/* Chess Piece Layer */}
                                                            {chessMode && piece && (
                                                                <span className={`chess-piece animate-piece ${piece.color === 'w' ? 'white' : 'black'}`}>
                                                                    {PIECES[piece.color + piece.type.toUpperCase()]}
                                                                </span>
                                                            )}

                                                            {/* Sprint Mode Node Display (if not chess) */}
                                                            {!chessMode && (
                                                                <span className={`text-2xl font-black font-mono tracking-tighter number-glow ${isEndpoint ? 'scale-110 text-white' : 'opacity-80'}`}>
                                                                    {nodeNum}
                                                                </span>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="absolute inset-0 grid grid-cols-8 grid-rows-8 pointer-events-none opacity-5">
                                        {Array.from({ length: 64 }).map((_, i) => <div key={i} className="border-[0.5px] border-white/20"></div>)}
                                    </div>
                                </div>
                            </div>

                            <aside className="space-y-8">
                                {chessMode ? (
                                    <div className="bg-[#0a0a0f] p-8 rounded-[3rem] border border-white/5 shadow-2xl flex flex-col gap-6">
                                        <div className="flex items-center justify-between">
                                            <h3 className="text-xs font-black uppercase tracking-widest text-slate-500">Chess Combat Status</h3>
                                            <div className="px-3 py-1 bg-indigo-500/10 rounded-full border border-indigo-500/20 text-[10px] font-bold text-indigo-400">
                                                VS AI Level 1
                                            </div>
                                        </div>

                                        <div className="space-y-3">
                                            <div className="flex justify-between items-center bg-white/5 p-4 rounded-2xl border border-white/5">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-8 h-8 bg-white rounded-lg flex items-center justify-center text-slate-900 font-bold">W</div>
                                                    <span className="text-sm font-bold">Thesis (You)</span>
                                                </div>
                                                {game.turn() === 'w' && <span className="text-[10px] font-black text-indigo-400 animate-pulse">YOUR TURN</span>}
                                            </div>
                                            <div className="flex justify-between items-center bg-white/5 p-4 rounded-2xl border border-white/5 opacity-80">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">B</div>
                                                    <span className="text-sm font-bold">External Critique (AI)</span>
                                                </div>
                                                {game.turn() === 'b' && <span className="text-[10px] font-black text-slate-500">THINKING...</span>}
                                            </div>
                                        </div>

                                        <div className="pt-4 border-t border-white/10">
                                            <div className="text-[10px] font-black text-slate-600 uppercase mb-2">Move History</div>
                                            <div className="grid grid-cols-2 gap-2 max-h-[120px] overflow-y-auto pr-2">
                                                {moveHistory.slice(-10).map((m, i) => (
                                                    <div key={i} className="text-[11px] font-mono text-slate-400 bg-white/5 px-2 py-1 rounded">
                                                        {i+1}. {m}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <button 
                                            onClick={() => { setGame(new Chess()); setMoveHistory([]); }}
                                            className="w-full py-4 bg-slate-800 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-700 transition-all"
                                        >
                                            Reset Match
                                        </button>
                                    </div>
                                ) : testMode ? (
                                    <div className="bg-indigo-600 p-10 rounded-[3rem] shadow-2xl relative overflow-hidden flex flex-col gap-6 items-center text-center">
                                        {!isFinished ? (
                                            <>
                                                <div className="text-[11px] text-white font-black uppercase tracking-[0.5em]">Memory Sprint ({stats.total + 1}/8)</div>
                                                <div className="text-8xl font-black text-white font-mono drop-shadow-2xl">{targetNode}</div>
                                                <div className="w-full h-2 bg-black/20 rounded-full overflow-hidden">
                                                    <div className="h-full bg-white timer-bar" style={{ width: `${(timeLeft / 5000) * 100}%` }} />
                                                </div>
                                                <input
                                                    ref={inputRef}
                                                    type="text"
                                                    value={userInput}
                                                    onChange={(e) => {
                                                        const v = e.target.value;
                                                        if (/^[1-8]?$/.test(v)) {
                                                            setUserInput(v);
                                                            if (v !== '') handleOutcome(parseInt(v) === Math.ceil(targetNode / 8), "FAIL");
                                                        }
                                                    }}
                                                    className="cluster-input"
                                                    maxLength="1"
                                                    autoFocus
                                                />
                                            </>
                                        ) : (
                                            <div className="space-y-6">
                                                <div className="text-xs text-white/60 uppercase font-black tracking-widest">Sprint Results</div>
                                                <div className="text-7xl font-black text-white">{Math.round((stats.correct/8)*100)}%</div>
                                                <button onClick={toggleDrill} className="px-8 py-4 bg-white text-indigo-900 rounded-2xl font-black uppercase text-xs tracking-widest">New Session</button>
                                            </div>
                                        )}
                                        {feedback && !isFinished && <div className="text-xs font-black uppercase text-white/90 bg-black/20 px-4 py-2 rounded-xl">{feedback.message}</div>}
                                    </div>
                                ) : (
                                    <div className="bg-[#0a0a0f] p-8 rounded-[3rem] border border-white/5 shadow-2xl space-y-6">
                                        <h3 className="text-xs font-black uppercase tracking-[0.3em] text-slate-500 mb-6 flex items-center gap-3">
                                            <Icon name="Palette" size={16} className="text-indigo-500" /> Highlighter Sync
                                        </h3>
                                        <div className="space-y-4">
                                            {rowColors.map((currentColor, idx) => (
                                                <div key={idx} className="flex items-center justify-between group">
                                                    <span className="text-[11px] font-black text-slate-600 uppercase">Rank {idx + 1}</span>
                                                    <div className="flex gap-1.5 bg-black/40 p-1.5 rounded-full">
                                                        {['emerald', 'amber', 'blue', 'purple'].map(c => (
                                                            <button
                                                                key={c}
                                                                onClick={() => updateRowColor(idx, c)}
                                                                className={`w-5 h-5 rounded-full border-2 transition-all ${c === 'emerald' ? 'bg-emerald-500' : c === 'amber' ? 'bg-amber-500' : c === 'blue' ? 'bg-blue-500' : 'bg-purple-500'} ${currentColor === c ? 'border-white scale-110 shadow-lg' : 'border-transparent opacity-20 hover:opacity-100'}`}
                                                            />
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </aside>
                        </div>
                        
                        <footer className="mt-12 py-8 border-t border-white/5 flex justify-between items-center opacity-30 text-[9px] uppercase font-black tracking-[0.3em]">
                            <div>Combat Mastery v2.0.0</div>
                            <div className="flex items-center gap-4">
                                <span>Chess.js Engine</span>
                                <span>Firebase Persistent State</span>
                            </div>
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
