<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Web Chessboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%236366f1%22/><rect width=%2250%22 height=%2250%22 fill=%22rgba(255,255,255,0.4)%22/><rect x=%2250%22 y=%2250%22 width=%2250%22 height=%2250%22 fill=%22rgba(255,255,255,0.4)%22/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains+Mono', monospace; }
        
        .tile-light { background-color: rgba(255, 255, 255, 0.12); border-color: rgba(255, 255, 255, 0.05); }
        .tile-dark { background-color: rgba(0, 0, 0, 0.4); border-color: rgba(0, 0, 0, 0.2); }
        
        .number-glow { text-shadow: 0 0 12px rgba(255,255,255,0.4), 0 0 2px rgba(0,0,0,0.8); }

        .chess-piece {
            font-size: 3.2rem;
            cursor: pointer;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.7));
            user-select: none;
            line-height: 1;
            z-index: 30;
        }
        .chess-piece.white { color: #ffffff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .chess-piece.black { color: #818cf8; text-shadow: 0 0 10px rgba(129,140,248,0.5); } 

        .captured-tray {
            min-height: 48px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0 16px;
            border-radius: 16px;
        }

        .timer-bar { transition: width 100ms linear; }
        .chessboard-container { transition: opacity 0.8s ease-in-out, filter 0.8s ease-in-out; }

        .cluster-input {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: white; text-align: center; font-size: 3rem; font-weight: 900;
            width: 80px; height: 80px; border-radius: 1rem; outline: none;
            transition: all 0.2s;
        }
        .cluster-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
            background: rgba(255, 255, 255, 0.1);
        }
        .valid-move-hint {
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- GLOBAL CONSTANTS ---
        const PIECES = {
            wP: '♙', wN: '♘', wB: '♗', wR: '♖', wQ: '♕', wK: '♔',
            bP: '♟', bN: '♞', bB: '♝', bR: '♜', bQ: '♛', bK: '♚'
        };

        const PIECE_NAMES = {
            p: 'Pawn', n: 'Knight', b: 'Bishop', r: 'Rook', q: 'Queen', k: 'King'
        };

        const colorClasses = {
            emerald: 'border-emerald-500/60 text-emerald-300 ring-emerald-500/30 shadow-[inset_0_0_30px_rgba(16,185,129,0.15)]',
            amber: 'border-amber-500/60 text-amber-300 ring-amber-500/30 shadow-[inset_0_0_30px_rgba(245,158,11,0.15)]',
            blue: 'border-blue-500/60 text-blue-300 ring-blue-500/30 shadow-[inset_0_0_30px_rgba(59,130,246,0.15)]',
            purple: 'border-purple-500/60 text-purple-300 ring-purple-500/30 shadow-[inset_0_0_30px_rgba(168,85,247,0.15)]'
        };

        const btnClasses = {
            emerald: 'bg-emerald-500',
            amber: 'bg-amber-500',
            blue: 'bg-blue-500',
            purple: 'bg-purple-500'
        };

        // --- FIREBASE INIT ---
        const isCanvasEnv = typeof __firebase_config !== 'undefined';
        const myProductionConfig = {
            apiKey: "", // Handle at runtime
            authDomain: "thesis-memory-web.firebaseapp.com",
            projectId: "thesis-memory-web",
            storageBucket: "thesis-memory-web.firebasestorage.app",
            messagingSenderId: "1000243001742",
            appId: "1:1000243001742:web:e367ebe8af3f6dcef14cdf"
        };
        const firebaseConfig = isCanvasEnv ? JSON.parse(__firebase_config) : myProductionConfig;
        const platformAppId = isCanvasEnv ? (typeof __app_id !== 'undefined' ? __app_id : 'thesis-memory-web') : 'production';

        const firebase = window.firebase;
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const Icon = ({ name, size = 16, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    const kebabName = name.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase().replace(/^-/, '');
                    i.setAttribute('data-lucide', kebabName);
                    if (className) i.setAttribute('class', className);
                    i.style.width = size + 'px'; i.style.height = size + 'px';
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons();
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="flex items-center justify-center shrink-0" />;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [rowColors, setRowColors] = useState(['emerald', 'emerald', 'blue', 'blue', 'purple', 'purple', 'amber', 'amber']);
            const [chessMode, setChessMode] = useState(false);
            const [testMode, setTestMode] = useState(false);
            const [stats, setStats] = useState({ correct: 0, total: 0 });
            const [isFinished, setIsFinished] = useState(false);
            const [saveStatus, setSaveStatus] = useState('synced');
            
            // Chess State
            const [game, setGame] = useState(new Chess());
            const [capturedByWhite, setCapturedByWhite] = useState([]);
            const [capturedByBlack, setCapturedByBlack] = useState([]);
            const [statusMessage, setStatusMessage] = useState("Awaiting deployment...");
            const [selectedSquare, setSelectedSquare] = useState(null);
            const [validMoves, setValidMoves] = useState([]);

            // Memory Drill State
            const [targetNode, setTargetNode] = useState(null);
            const [timeLeft, setTimeLeft] = useState(5000);
            const [userInput, setUserInput] = useState('');
            const [feedback, setFeedback] = useState(null);
            const inputRef = useRef(null);

            // --- AUTH & SYNC ---
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged(setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const path = isCanvasEnv 
                    ? db.collection('artifacts').doc(platformAppId).collection('users').doc(user.uid).collection('state').doc('trainerConfig')
                    : db.collection('thesis_data').doc(platformAppId).collection('users').doc(user.uid).collection('trainer').doc('config');
                
                return path.onSnapshot(doc => {
                    if (doc.exists) setRowColors(doc.data().rowColors);
                });
            }, [user]);

            const updateRowColor = async (idx, color) => {
                const newColors = [...rowColors];
                newColors[idx] = color;
                setRowColors(newColors);
                if (!user) return;
                setSaveStatus('saving');
                const path = isCanvasEnv 
                    ? db.collection('artifacts').doc(platformAppId).collection('users').doc(user.uid).collection('state').doc('trainerConfig')
                    : db.collection('thesis_data').doc(platformAppId).collection('users').doc(user.uid).collection('trainer').doc('config');
                await path.set({ rowColors: newColors }, { merge: true });
                setSaveStatus('synced');
            };

            // --- CHESS LOGIC ---
            const handleMove = useCallback((move) => {
                const gameCopy = new Chess(game.fen());
                const result = gameCopy.move(move);
                
                if (result) {
                    setGame(gameCopy);
                    
                    if (result.captured) {
                        const capturedPiece = (result.color === 'w' ? 'b' : 'w') + result.captured.toUpperCase();
                        const pieceIcon = PIECES[capturedPiece];
                        if (result.color === 'w') {
                            setCapturedByWhite(prev => [...prev, pieceIcon]);
                        } else {
                            setCapturedByBlack(prev => [...prev, pieceIcon]);
                        }
                        setStatusMessage(`${result.color === 'w' ? 'White' : 'Black'} ${PIECE_NAMES[result.piece]} captured ${result.color === 'w' ? 'Black' : 'White'} ${PIECE_NAMES[result.captured]}!`);
                    } else {
                        setStatusMessage(`${result.color === 'w' ? 'White' : 'Black'} ${PIECE_NAMES[result.piece]} moved to ${result.to}.`);
                    }
                    return true;
                }
                return false;
            }, [game]);

            useEffect(() => {
                if (chessMode && game.turn() === 'b' && !game.game_over()) {
                    const timer = setTimeout(() => {
                        const moves = game.moves();
                        if (moves.length) handleMove(moves[Math.floor(Math.random() * moves.length)]);
                    }, 800);
                    return () => clearTimeout(timer);
                }
            }, [game, chessMode, handleMove]);

            const onSquareClick = (square) => {
                if (!chessMode || game.game_over() || game.turn() === 'b') return;
                const piece = game.get(square);
                
                if (piece && piece.color === 'w') {
                    setSelectedSquare(square);
                    const moves = game.moves({ square, verbose: true });
                    setValidMoves(moves.map(m => m.to));
                    return;
                }
                
                if (selectedSquare) {
                    handleMove({ from: selectedSquare, to: square, promotion: 'q' });
                    setSelectedSquare(null);
                    setValidMoves([]);
                }
            };

            // --- DRILL LOGIC ---
            const startSprint = () => {
                setStats({ correct: 0, total: 0 });
                setIsFinished(false);
                setTestMode(true);
                setChessMode(false);
                nextTarget();
            };

            const nextTarget = () => {
                setTargetNode(Math.floor(Math.random() * 64) + 1);
                setFeedback(null);
                setTimeLeft(5000);
                setUserInput('');
                setTimeout(() => inputRef.current?.focus(), 100);
            };

            useEffect(() => {
                let timer;
                if (testMode && !feedback && !isFinished && timeLeft > 0) {
                    timer = setInterval(() => setTimeLeft(t => t - 100), 100);
                } else if (timeLeft <= 0 && !feedback && testMode) {
                    processAnswer(false, "TIME OUT");
                }
                return () => clearInterval(timer);
            }, [testMode, timeLeft, feedback, isFinished]);

            const processAnswer = (success, msg) => {
                const correct = Math.ceil(targetNode / 8);
                setStats(s => ({ ...s, total: s.total + 1, correct: success ? s.correct + 1 : s.correct }));
                setFeedback({ success, message: success ? "TARGET LOCKED" : `${msg}. Cluster: ${correct}` });
                if (stats.total + 1 >= 8) setTimeout(() => setIsFinished(true), 1500);
                else setTimeout(nextTarget, success ? 800 : 2000);
            };

            const getChessSquareName = (r, c) => {
                const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
                const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
                return files[c] + ranks[r];
            };

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center selection:bg-indigo-500 selection:text-white">
                    <div className="max-w-6xl w-full">
                        {/* Header */}
                        <header className="flex flex-col md:flex-row items-center justify-between gap-6 mb-8">
                            <div className="flex items-center gap-5">
                                <div className="w-14 h-14 bg-indigo-600 rounded-3xl flex items-center justify-center shadow-2xl shadow-indigo-600/40">
                                    <Icon name="ShieldCheck" size={32} className="text-white" />
                                </div>
                                <div>
                                    <h1 className="text-3xl font-black italic tracking-tight leading-none mb-1 uppercase">Tactical Web</h1>
                                    <div className="flex items-center gap-3">
                                        <a href="thesis-memory-web.html" className="text-[10px] font-black uppercase text-slate-500 hover:text-white transition-colors">← Back to Web</a>
                                        <span className={`text-[10px] font-bold uppercase ${saveStatus === 'saving' ? 'text-indigo-400' : 'text-emerald-500/50'}`}>
                                            {saveStatus === 'saving' ? 'Syncing...' : 'Cloud Locked'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                <button onClick={() => { setChessMode(!chessMode); setTestMode(false); setSelectedSquare(null); setValidMoves([]); }} className={`px-6 py-3 rounded-2xl text-xs font-black uppercase tracking-widest transition-all ${chessMode ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-800 text-slate-400'}`}>
                                    <Icon name="Sword" size={16} className="inline mr-2"/> {chessMode ? 'Combat Active' : 'Chess Combat'}
                                </button>
                                <button onClick={testMode ? () => setTestMode(false) : startSprint} className={`px-6 py-3 rounded-2xl text-xs font-black uppercase tracking-widest transition-all ${testMode ? 'bg-red-500/10 text-red-400 border border-red-500/30' : 'bg-white text-indigo-900 shadow-xl'}`}>
                                    <Icon name={testMode ? "XCircle" : "Zap"} size={16} className="inline mr-2"/> {testMode ? 'Abort' : 'Sprint'}
                                </button>
                            </div>
                        </header>

                        <div className="grid lg:grid-cols-[1fr_360px] gap-8 items-start">
                            <div className="space-y-4">
                                {chessMode && (
                                    <div className="flex items-center justify-between opacity-60">
                                        <span className="text-[10px] font-black uppercase tracking-widest text-slate-500">Captured by AI</span>
                                        <div className="captured-tray w-3/4">
                                            {capturedByBlack.map((p, i) => <span key={i} className="text-2xl text-white">{p}</span>)}
                                        </div>
                                    </div>
                                )}

                                <div className={`bg-slate-900/50 p-1.5 rounded-[3.5rem] border border-white/5 shadow-2xl chessboard-container ${testMode && !isFinished ? 'opacity-10 grayscale' : 'opacity-100'}`}>
                                    <div className="p-4 bg-black/60 rounded-[3rem] border border-white/10 relative overflow-hidden">
                                        <div className="grid grid-rows-8 gap-1.5 relative z-10">
                                            {rowColors.map((color, rIdx) => (
                                                <div key={rIdx} className="grid grid-cols-8 gap-1.5">
                                                    {Array.from({ length: 8 }).map((_, cIdx) => {
                                                        const nodeNum = (rIdx * 8) + cIdx + 1;
                                                        const sqName = getChessSquareName(rIdx, cIdx);
                                                        const piece = game.get(sqName);
                                                        const isLight = (rIdx + cIdx) % 2 === 0;
                                                        const isSelected = selectedSquare === sqName;
                                                        const isValidMove = validMoves.includes(sqName);

                                                        return (
                                                            <div key={cIdx} onClick={() => onSquareClick(sqName)} className={`aspect-square rounded-xl border-2 flex items-center justify-center relative node-button ${isLight ? 'tile-light' : 'tile-dark'} ${isSelected ? 'ring-4 ring-indigo-500 z-20 scale-105' : ''} ${colorClasses[color]} ${testMode && targetNode === nodeNum ? 'ring-4 ring-white animate-pulse' : ''} ${chessMode ? 'cursor-pointer' : 'cursor-default'}`}>
                                                                <span className="absolute top-1 left-1.5 text-[9px] font-black opacity-20 font-mono">{nodeNum}</span>
                                                                {chessMode && isValidMove && <div className="absolute inset-0 flex items-center justify-center"><div className="valid-move-hint" /></div>}
                                                                {chessMode && piece && <span className={`chess-piece animate-piece ${piece.color === 'w' ? 'white' : 'black'}`}>{PIECES[piece.color + piece.type.toUpperCase()]}</span>}
                                                                {!chessMode && <span className="text-2xl font-black font-mono tracking-tighter number-glow opacity-90">{nodeNum}</span>}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {chessMode && (
                                    <div className="flex items-center justify-between">
                                        <div className="captured-tray w-3/4">
                                            {capturedByWhite.map((p, i) => <span key={i} className="text-2xl text-indigo-400">{p}</span>)}
                                        </div>
                                        <span className="text-[10px] font-black uppercase tracking-widest text-indigo-400">Captured by You</span>
                                    </div>
                                )}
                            </div>

                            <aside className="space-y-6">
                                {chessMode ? (
                                    <div className="bg-[#0a0a0f] p-8 rounded-[3rem] border border-white/5 shadow-2xl flex flex-col gap-6">
                                        <div className="bg-indigo-600/10 border border-indigo-500/20 p-5 rounded-3xl">
                                            <span className="text-[10px] font-black text-indigo-400 uppercase tracking-widest block mb-2">Combat Status</span>
                                            <p className="text-sm font-bold text-white italic leading-relaxed">"{statusMessage}"</p>
                                        </div>
                                        <div className="space-y-3">
                                            <div className={`p-4 rounded-2xl border flex justify-between items-center transition-all ${game.turn() === 'w' ? 'bg-indigo-500/10 border-indigo-500/50' : 'bg-white/5 border-white/5 opacity-50'}`}>
                                                <span className="text-sm font-bold">Thesis (White)</span>
                                                {game.turn() === 'w' && <Icon name="Zap" size={14} className="text-indigo-400 animate-pulse"/>}
                                            </div>
                                            <div className={`p-4 rounded-2xl border flex justify-between items-center transition-all ${game.turn() === 'b' ? 'bg-indigo-500/10 border-indigo-500/50' : 'bg-white/5 border-white/5 opacity-50'}`}>
                                                <span className="text-sm font-bold">Critique (Black)</span>
                                                {game.turn() === 'b' && <Icon name="Cpu" size={14} className="text-indigo-400 animate-pulse"/>}
                                            </div>
                                        </div>
                                        <button onClick={() => { setGame(new Chess()); setCapturedByBlack([]); setCapturedByWhite([]); setSelectedSquare(null); setValidMoves([]); setStatusMessage("Game Reset."); }} className="w-full py-4 bg-slate-800 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-700">Reset Match</button>
                                    </div>
                                ) : testMode ? (
                                    <div className="bg-indigo-600 p-10 rounded-[3rem] shadow-2xl flex flex-col items-center gap-6 text-center">
                                        {!isFinished ? (
                                            <>
                                                <div className="text-[10px] font-black uppercase tracking-widest text-white/60">Node Sprint {stats.total + 1}/8</div>
                                                <div className="text-8xl font-black text-white font-mono tracking-tighter drop-shadow-2xl">{targetNode}</div>
                                                <div className="w-full h-2 bg-black/20 rounded-full overflow-hidden">
                                                    <div className="h-full bg-white timer-bar shadow-[0_0_10px_white]" style={{ width: `${(timeLeft / 5000) * 100}%` }} />
                                                </div>
                                                <input ref={inputRef} type="text" value={userInput} onChange={e => {
                                                    const v = e.target.value;
                                                    if (/^[1-8]?$/.test(v)) {
                                                        setUserInput(v);
                                                        if (v !== '') processAnswer(parseInt(v) === Math.ceil(targetNode / 8), "MISS");
                                                    }
                                                }} className="cluster-input" maxLength="1" autoFocus />
                                            </>
                                        ) : (
                                            <div className="space-y-4">
                                                <div className="text-6xl font-black text-white">{Math.round(stats.correct/8*100)}%</div>
                                                <p className="text-xs font-bold uppercase tracking-widest text-indigo-200">Sprint Accuracy</p>
                                                <button onClick={startSprint} className="px-8 py-3 bg-white text-indigo-900 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-xl">Restart</button>
                                            </div>
                                        )}
                                        {feedback && !isFinished && <div className="text-xs font-black uppercase text-white/80 bg-black/20 px-4 py-2 rounded-lg">{feedback.message}</div>}
                                    </div>
                                ) : (
                                    <div className="bg-[#0a0a0f] p-8 rounded-[3rem] border border-white/5 shadow-2xl space-y-6">
                                        <h3 className="text-xs font-black uppercase tracking-[0.4em] text-slate-500 mb-2">Highlighter Sync</h3>
                                        <div className="space-y-4">
                                            {rowColors.map((curr, idx) => (
                                                <div key={idx} className="flex items-center justify-between">
                                                    <span className="text-[10px] font-black text-slate-500 uppercase">Rank {idx + 1}</span>
                                                    <div className="flex gap-1.5 p-1.5 bg-black rounded-full border border-white/5">
                                                        {['emerald', 'amber', 'blue', 'purple'].map(c => (
                                                            <button key={c} onClick={() => updateRowColor(idx, c)} className={`w-5 h-5 rounded-full border-2 transition-all ${btnClasses[c]} ${curr === c ? 'border-white scale-110 shadow-lg' : 'border-transparent opacity-20'}`} />
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </aside>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
