<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50' y='50' font-size='72' text-anchor='middle' dominant-baseline='central'>ðŸ”—</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thesis Memory Web</title>
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for Browser-side Compilation -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK (Compat versions for easier browser integration) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @keyframes dash { to { stroke-dashoffset: -100; } }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        
        .node-grid-bg { background: radial-gradient(circle at center, #0f172a 0%, #020617 100%); }
        .node-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .lucide { display: inline-block; vertical-align: middle; }
        
        /* Master container for the scaling workspace */
        .workspace-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: calc(100vh - 64px); 
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }

        #scaling-wrapper {
            transition: transform 0.2s ease-out;
            transform-origin: center top;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            will-change: transform;
        }

        .drag-ghost {
            opacity: 0.2;
            filter: grayscale(1);
        }

        .drag-over-target {
            box-shadow: 0 0 0 2px #6366f1, 0 0 20px rgba(99, 102, 241, 0.4);
            transform: scale(1.02);
            z-index: 50;
        }

        .quick-emoji {
            cursor: pointer;
            transition: transform 0.1s;
        }
        .quick-emoji:hover {
            transform: scale(1.2);
        }

        .card-drag-over {
            border-color: #6366f1 !important;
            background-color: rgba(99, 102, 241, 0.1) !important;
            transform: translateY(-2px);
        }

        /* Tooltip animation */
        .tooltip-animate {
            animation: tooltip-in 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes tooltip-in {
            from { opacity: 0; transform: translate(-50%, 10px) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, 0) scale(1); }
        }
    </style>
</head>
<body class="bg-[#020204] text-slate-100 overflow-hidden h-screen w-screen font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        const isCanvasEnv = typeof __firebase_config !== 'undefined';
        
        const myProductionConfig = {
            apiKey: "AIzaSyCCAMapMCPHeXUvmR0DF4ERl8ay58Rz37w",
            authDomain: "thesis-memory-web.firebaseapp.com",
            projectId: "thesis-memory-web",
            storageBucket: "thesis-memory-web.firebasestorage.app",
            messagingSenderId: "1000243001742",
            appId: "1:1000243001742:web:e367ebe8af3f6dcef14cdf"
        };

        const firebaseConfig = isCanvasEnv ? JSON.parse(__firebase_config) : myProductionConfig;
        const platformAppId = isCanvasEnv ? (typeof __app_id !== 'undefined' ? __app_id : 'thesis-memory-web') : 'production';

        const firebase = window.firebase;
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const Icon = ({ name, size = 16, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    const kebabName = name.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase().replace(/^-/, '');
                    i.setAttribute('data-lucide', kebabName);
                    if (className) i.setAttribute('class', className);
                    i.style.width = size + 'px';
                    i.style.height = size + 'px';
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons();
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="flex items-center justify-center leading-none shrink-0" />;
        };

        const App = () => {
            const [time, setTime] = useState(new Date());
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [saveStatus, setSaveStatus] = useState('synced');
            const [errorMessage, setErrorMessage] = useState(null);
            
            const [scale, setScale] = useState(1);
            const [titleFontSize, setTitleFontSize] = useState(10); 
            const [sectionOrder, setSectionOrder] = useState([0, 1, 2, 3, 4, 5, 6, 7]);
            const [draggedIndex, setDraggedIndex] = useState(null);
            const [dragOverIndex, setDragOverIndex] = useState(null);

            const [draggedCardIndex, setDraggedCardIndex] = useState(null);
            const [dragOverCardIndex, setDragOverCardIndex] = useState(null);

            // QoL: Track hovered node
            const [hoveredNodeKey, setHoveredNodeKey] = useState(null);

            const [showAuthModal, setShowAuthModal] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [authLoading, setAuthLoading] = useState(false);

            const [selectedNode, setSelectedNode] = useState(null);
            const [linkingNode, setLinkingNode] = useState(null);
            const [connections, setConnections] = useState([]);
            const [nodesData, setNodesData] = useState({});
            const [sectionTitles, setSectionTitles] = useState([
                "Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4",
                "Cluster 5", "Cluster 6", "Cluster 7", "Cluster 8"
            ]);

            const sections = [
                { id: 0, color: "text-blue-400", border: "border-blue-500/30", bg: "bg-blue-500/5", dot: "bg-blue-500" },
                { id: 1, color: "text-emerald-400", border: "border-emerald-500/30", bg: "bg-emerald-500/5", dot: "bg-emerald-500" },
                { id: 2, color: "text-amber-400", border: "border-amber-500/30", bg: "bg-amber-500/10", dot: "bg-amber-500" },
                { id: 3, color: "text-purple-400", border: "border-purple-500/30", bg: "bg-purple-500/5", dot: "bg-purple-500" },
                { id: 4, color: "text-pink-400", border: "border-pink-500/30", bg: "bg-pink-500/10", dot: "bg-pink-500" },
                { id: 5, color: "text-orange-400", border: "border-orange-500/30", bg: "bg-orange-500/10", dot: "bg-orange-500" },
                { id: 6, color: "text-indigo-400", border: "border-indigo-500/30", bg: "bg-indigo-500/10", dot: "bg-indigo-500" },
                { id: 7, color: "text-cyan-400", border: "border-cyan-500/30", bg: "bg-cyan-500/5", dot: "bg-cyan-500" }
            ];

            const quickEmojis = ["ðŸŸ¢", "ðŸ“—", "ðŸŒ±", "ðŸ§ª", "ðŸŸ¡", "ðŸ’¡", "âš ï¸", "ðŸ§©", "ðŸ”µ", "ðŸ”—", "ðŸŒ", "âš™ï¸", "ðŸŸ£", "ðŸŒ¸", "ðŸ’—", "ðŸ©¸"];

            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            const gmtString = time.toLocaleTimeString('en-GB', { 
                timeZone: 'GMT', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false 
            });

            useEffect(() => {
                const handleResize = () => {
                    const sidebarWidth = window.innerWidth > 1200 ? 450 : (window.innerWidth > 1024 ? 380 : 320);
                    const headerHeight = 64;
                    const padding = window.innerHeight < 800 ? 30 : 60; 
                    
                    const availableWidth = window.innerWidth - sidebarWidth - padding; 
                    const availableHeight = window.innerHeight - headerHeight - padding;
                    
                    const baseWidth = 980;
                    const baseHeight = 780;
                    
                    const scaleW = availableWidth / baseWidth;
                    const scaleH = availableHeight / baseHeight;
                    
                    const newScale = Math.min(scaleW, scaleH, 1);
                    setScale(newScale);
                };
                
                window.addEventListener('resize', handleResize);
                handleResize();
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                const performAuth = async () => {
                    try {
                        if (isCanvasEnv && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else if (!auth.currentUser) {
                            await auth.signInAnonymously();
                        }
                    } catch (err) { console.error(err); }
                };
                performAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const pathPrefix = isCanvasEnv ? 'artifacts' : 'thesis_data';
                const docRef = isCanvasEnv 
                    ? db.collection('artifacts').doc(platformAppId).collection('users').doc(user.uid).collection('state').doc('memoryWeb')
                    : db.collection('thesis_data').doc(platformAppId).collection('users').doc(user.uid);
                
                const unsubscribe = docRef.onSnapshot((docSnap) => {
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        if (data.nodesData) setNodesData(data.nodesData);
                        if (data.connections) setConnections(data.connections);
                        if (data.sectionTitles) setSectionTitles(data.sectionTitles);
                        if (data.sectionOrder) setSectionOrder(data.sectionOrder);
                        if (data.titleFontSize) setTitleFontSize(data.titleFontSize);
                    }
                    setLoading(false);
                }, (err) => {
                    setErrorMessage("Connection Error: Update rules or check internet.");
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            const saveData = async (updates = {}) => {
                if (!user) return;
                setSaveStatus('saving');
                try {
                    const docRef = isCanvasEnv 
                        ? db.collection('artifacts').doc(platformAppId).collection('users').doc(user.uid).collection('state').doc('memoryWeb')
                        : db.collection('thesis_data').doc(platformAppId).collection('users').doc(user.uid);

                    const finalData = {
                        nodesData: updates.nodesData || nodesData,
                        sectionTitles: updates.sectionTitles || sectionTitles,
                        connections: updates.connections || connections,
                        sectionOrder: updates.sectionOrder || sectionOrder,
                        titleFontSize: updates.titleFontSize || titleFontSize,
                        lastUpdated: new Date().toISOString()
                    };

                    await docRef.set(finalData, { merge: true });
                    setSaveStatus('synced');
                } catch (err) {
                    console.error(err);
                    setSaveStatus('error');
                }
            };

            const handleEmailAuth = async (e) => {
                e.preventDefault();
                setErrorMessage(null);
                setAuthLoading(true);
                try {
                    if (isRegistering) {
                        await auth.createUserWithEmailAndPassword(email, password);
                    } else {
                        await auth.signInWithEmailAndPassword(email, password);
                    }
                    setShowAuthModal(false);
                } catch (err) {
                    setErrorMessage(err.message);
                } finally {
                    setAuthLoading(false);
                }
            };

            const handleLogout = () => {
                auth.signOut();
                setSelectedNode(null);
                setErrorMessage(null);
            };

            const handleDragStart = (e, index) => {
                setDraggedIndex(index);
                e.dataTransfer.effectAllowed = 'move';
                const img = new Image();
                img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                e.dataTransfer.setDragImage(img, 0, 0);
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                if (draggedIndex !== index) {
                    setDragOverIndex(index);
                }
            };

            const handleDrop = (e, targetIndex) => {
                e.preventDefault();
                setDragOverIndex(null);
                if (draggedIndex === null || draggedIndex === targetIndex) {
                    setDraggedIndex(null);
                    return;
                }

                const newOrder = [...sectionOrder];
                const item = newOrder.splice(draggedIndex, 1)[0];
                newOrder.splice(targetIndex, 0, item);
                
                setSectionOrder(newOrder);
                setDraggedIndex(null);
                saveData({ sectionOrder: newOrder });
            };

            const handleCardDragStart = (e, index) => {
                setDraggedCardIndex(index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleCardDragOver = (e, index) => {
                e.preventDefault();
                setDragOverCardIndex(index);
            };

            const handleCardDrop = (e, targetIndex, sortedConnections, nodeKey) => {
                e.preventDefault();
                const sourceIndex = draggedCardIndex;
                setDraggedCardIndex(null);
                setDragOverCardIndex(null);

                if (sourceIndex === null || sourceIndex === targetIndex) return;

                const newSorted = [...sortedConnections];
                const [moved] = newSorted.splice(sourceIndex, 1);
                newSorted.splice(targetIndex, 0, moved);

                const updatedNodes = { 
                    ...nodesData, 
                    [nodeKey]: { 
                        ...(nodesData[nodeKey] || {}), 
                        connectionOrder: newSorted 
                    } 
                };
                setNodesData(updatedNodes);
                saveData({ nodesData: updatedNodes });
            };

            const getNodeKey = (sIdx, nIdx) => `${sIdx}-${nIdx}`;
            const getGlobalIndex = (sIdx, nIdx) => (sIdx * 8) + nIdx + 1;

            const handleNodeClick = (sIdx, nIdx) => {
                const key = getNodeKey(sIdx, nIdx);
                if (linkingNode) {
                    if (linkingNode !== key) {
                        const newConn = [linkingNode, key].sort().join(':');
                        if (!connections.includes(newConn)) {
                            const updatedConns = [...connections, newConn];
                            setConnections(updatedConns);
                            saveData({ connections: updatedConns });
                        }
                    }
                    setLinkingNode(null);
                } else {
                    setSelectedNode({ sIdx, nIdx });
                }
            };

            const removeConnection = (connStr) => {
                const updated = connections.filter(c => c !== connStr);
                setConnections(updated);
                if (selectedNode) {
                    const nodeKey = getNodeKey(selectedNode.sIdx, selectedNode.nIdx);
                    const oldOrder = nodesData[nodeKey]?.connectionOrder || [];
                    const newOrder = oldOrder.filter(c => c !== connStr);
                    const updatedNodes = { 
                        ...nodesData, 
                        [nodeKey]: { ...(nodesData[nodeKey] || {}), connectionOrder: newOrder } 
                    };
                    setNodesData(updatedNodes);
                    saveData({ connections: updated, nodesData: updatedNodes });
                } else {
                    saveData({ connections: updated });
                }
            };

            const updateNodeData = (field, value) => {
                if (!selectedNode) return;
                const key = getNodeKey(selectedNode.sIdx, selectedNode.nIdx);
                const updatedNodes = { ...nodesData, [key]: { ...(nodesData[key] || {}), [field]: value } };
                setNodesData(updatedNodes);
                saveData({ nodesData: updatedNodes });
            };

            const updateSectionTitle = (index, value) => {
                const newTitles = [...sectionTitles];
                newTitles[index] = value;
                setSectionTitles(newTitles);
                saveData({ sectionTitles: newTitles });
            };

            const adjustFontSize = (dir) => {
                const newSize = Math.max(6, Math.min(32, titleFontSize + dir));
                setTitleFontSize(newSize);
                saveData({ titleFontSize: newSize });
            }

            if (loading && !errorMessage) return <div className="h-screen flex items-center justify-center font-mono text-xs text-indigo-500 bg-[#020204]">Initializing Web...</div>;

            const scaledHeight = 780 * scale + 80;
            const viewportHeight = window.innerHeight - 64;
            const topMargin = scaledHeight < viewportHeight ? (viewportHeight - scaledHeight) / 2 : 0;

            return (
                <div className="h-screen flex flex-col font-sans bg-[#020204] overflow-hidden">
                    <header className="p-4 border-b border-white/5 flex justify-between items-center bg-[#050508]/80 backdrop-blur-xl z-50">
                        <div className="flex items-center gap-4">
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-600/20">
                                <Icon name="Network" size={22} className="text-white" />
                            </div>
                            <div>
                                <h1 className="text-sm font-bold tracking-widest uppercase text-slate-200">Thesis Memory Web</h1>
                                <div className="flex items-center gap-2 mt-0.5">
                                    <div className={`text-[10px] uppercase font-bold ${saveStatus === 'synced' ? 'text-emerald-500' : 'text-indigo-400'}`}>
                                        {saveStatus === 'saving' ? 'Syncing...' : 'Cloud Active'}
                                    </div>
                                    <div className="h-3 w-px bg-white/10 mx-2" />
                                    <div className="flex items-center gap-1">
                                        <span className="text-[9px] text-slate-500 uppercase tracking-tighter">Titles</span>
                                        <button onClick={() => adjustFontSize(-1)} className="w-5 h-5 flex items-center justify-center bg-white/5 hover:bg-white/10 rounded border border-white/10 text-xs">-</button>
                                        <button onClick={() => adjustFontSize(1)} className="w-5 h-5 flex items-center justify-center bg-white/5 hover:bg-white/10 rounded border border-white/10 text-xs">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="flex items-center gap-6">
                            <div className="flex flex-col items-end pr-4 border-r border-white/10">
                                <span className="text-[8px] text-slate-600 uppercase font-bold tracking-widest">GMT/UTC</span>
                                <span className="text-[11px] text-cyan-400 font-mono font-bold tracking-tighter">
                                    {gmtString}
                                </span>
                            </div>

                            <div className="flex items-center gap-4">
                                {user && !user.isAnonymous ? (
                                    <div className="flex items-center gap-3 text-right">
                                        <div className="hidden md:flex flex-col">
                                            <span className="text-[9px] text-slate-600 uppercase font-bold tracking-tighter">Verified User</span>
                                            <span className="text-[10px] text-indigo-400 font-mono">{user.email}</span>
                                        </div>
                                        <button onClick={handleLogout} className="p-2 hover:bg-white/5 rounded-lg text-slate-500 hover:text-red-400 transition-colors">
                                            <Icon name="LogOut" size={18} />
                                        </button>
                                    </div>
                                ) : (
                                    <button onClick={() => setShowAuthModal(true)} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-lg">
                                        <Icon name="LogIn" size={14} /> SYNC ACCOUNT
                                    </button>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 flex overflow-hidden">
                        <section className="flex-1 relative node-grid-bg workspace-container">
                            <div id="scaling-wrapper" style={{ transform: `scale(${scale})`, marginTop: `${topMargin}px` }}>
                                <div id="grid-container" className="grid grid-cols-2 gap-8 p-10 bg-black/40 rounded-[4rem] border border-white/5 backdrop-blur-md shadow-2xl relative">
                                    {errorMessage && !showAuthModal && (
                                        <div className="absolute -top-12 left-0 right-0 text-center text-red-400 text-[10px] bg-red-500/10 p-2 rounded-lg border border-red-500/50 flex items-center justify-center gap-2 z-50">
                                            <Icon name="AlertCircle" size={12} /> {errorMessage} 
                                            <button onClick={() => setErrorMessage(null)} className="hover:text-white"><Icon name="X" size={12} /></button>
                                        </div>
                                    )}
                                    {sectionOrder.map((sectionId, displayIdx) => {
                                        const section = sections.find(s => s.id === sectionId);
                                        return (
                                            <div 
                                                key={section.id} 
                                                onDragOver={(e) => handleDragOver(e, displayIdx)}
                                                onDragLeave={() => setDragOverIndex(null)}
                                                onDrop={(e) => handleDrop(e, displayIdx)}
                                                className={`p-5 rounded-3xl border ${section.bg} ${section.border} flex flex-col gap-4 shadow-inner node-transition relative ${draggedIndex === displayIdx ? 'drag-ghost' : ''} ${dragOverIndex === displayIdx ? 'drag-over-target' : ''}`}
                                            >
                                                <div className="flex items-center justify-between pointer-events-none">
                                                    <div className={`font-bold uppercase tracking-widest ${section.color}`} style={{ fontSize: `${titleFontSize}px` }}>
                                                        {sectionTitles[section.id]}
                                                    </div>
                                                    <div 
                                                        draggable="true"
                                                        onDragStart={(e) => {
                                                            e.stopPropagation();
                                                            handleDragStart(e, displayIdx);
                                                        }}
                                                        className="cursor-grab active:cursor-grabbing opacity-30 hover:opacity-100 transition-opacity pointer-events-auto p-1"
                                                    >
                                                        <Icon name="GripHorizontal" size={14} className="text-slate-400" />
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-4 gap-3">
                                                    {Array.from({ length: 8 }).map((_, nIdx) => {
                                                        const key = getNodeKey(section.id, nIdx);
                                                        const selected = selectedNode?.sIdx === section.id && selectedNode?.nIdx === nIdx;
                                                        const hasConcept = !!nodesData[key]?.concept;
                                                        const conceptText = nodesData[key]?.concept;
                                                        const emoji = nodesData[key]?.emoji;
                                                        const isLinked = connections.some(c => c.includes(key));
                                                        const isLinkingSource = linkingNode === key;

                                                        return (
                                                            <button 
                                                                key={nIdx} 
                                                                id={`node-${section.id}-${nIdx}`} 
                                                                onClick={() => handleNodeClick(section.id, nIdx)} 
                                                                onMouseEnter={() => setHoveredNodeKey(key)}
                                                                onMouseLeave={() => setHoveredNodeKey(null)}
                                                                className={`w-12 h-12 rounded-2xl flex flex-col items-center justify-center transition-all duration-300 relative ${selected ? 'bg-white/10 ring-2 ring-indigo-500 scale-110 z-10 shadow-[0_0_20px_rgba(79,70,229,0.4)]' : 'bg-[#0a0a0f] border border-white/5 hover:border-white/20'} ${isLinkingSource ? 'animate-pulse ring-2 ring-emerald-500' : ''}`}
                                                            >
                                                                <span className={`font-mono mb-1 ${selected ? 'text-indigo-300' : 'text-slate-400'}`} style={{ fontSize: `${Math.max(titleFontSize, 9)}px` }}>
                                                                    {getGlobalIndex(section.id, nIdx)}
                                                                </span>
                                                                <div className="h-4 flex items-center justify-center">
                                                                    {emoji ? (
                                                                        <span className="text-base leading-none">{emoji}</span>
                                                                    ) : (
                                                                        <div className={`w-2 h-2 rounded-full transition-all duration-500 ${hasConcept ? section.dot : 'bg-slate-600'}`} />
                                                                    )}
                                                                </div>
                                                                {isLinked && <div className="absolute inset-2 rounded-xl border border-indigo-500/20 pointer-events-none" />}

                                                                {/* CONCEPT HOVER TOOLTIP */}
                                                                {hoveredNodeKey === key && conceptText && (
                                                                    <div className="absolute bottom-full mb-3 left-1/2 -translate-x-1/2 px-3 py-2 bg-[#050508]/95 border border-indigo-500/40 rounded-xl shadow-2xl z-[100] pointer-events-none min-w-[140px] max-w-[220px] backdrop-blur-md tooltip-animate">
                                                                        <div className="flex items-center gap-1.5 mb-1 opacity-50">
                                                                            <Icon name="Brain" size={10} className="text-indigo-400" />
                                                                            <span className="text-[8px] text-indigo-300 uppercase font-black tracking-widest">Cognitive Core</span>
                                                                        </div>
                                                                        <div className="text-slate-100 text-[11px] leading-tight font-medium italic break-words">
                                                                            "{conceptText}"
                                                                        </div>
                                                                        <div className="absolute top-full left-1/2 -translate-x-1/2 border-[6px] border-transparent border-t-[#050508]/95" />
                                                                    </div>
                                                                )}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </section>

                        <aside className="w-[320px] lg:w-[380px] xl:w-[450px] border-l border-white/5 bg-[#050508] p-6 lg:p-10 flex flex-col gap-8 lg:gap-10 overflow-y-auto shadow-2xl z-40 shrink-0 transition-all duration-300">
                            {selectedNode ? (
                                <div className="flex flex-col gap-8 animate-in slide-in-from-right duration-300">
                                    <div>
                                        <div className="text-[12px] text-indigo-400 uppercase font-bold tracking-widest mb-1">Node {getGlobalIndex(selectedNode.sIdx, selectedNode.nIdx)}</div>
                                        <h2 className="text-2xl lg:text-3xl font-thin text-white tracking-tight leading-none">Memory Node Detail</h2>
                                    </div>
                                    
                                    <div className="flex flex-col gap-6">
                                        <div className="flex flex-col gap-2 p-4 bg-white/5 rounded-2xl border border-white/5 group hover:border-white/10 transition-colors">
                                            <label className="text-[9px] text-slate-500 uppercase font-bold tracking-widest flex items-center gap-2">
                                                <Icon name="Edit3" size={12} className="text-slate-400" /> Cluster Name
                                            </label>
                                            <input type="text" value={sectionTitles[selectedNode.sIdx]} 
                                                onChange={(e) => updateSectionTitle(selectedNode.sIdx, e.target.value)}
                                                className="bg-transparent text-white text-sm font-semibold focus:outline-none focus:text-indigo-400 transition-colors" />
                                        </div>

                                        <div className="flex flex-col gap-3 p-4 bg-white/5 rounded-2xl border border-white/5">
                                            <label className="text-[9px] text-slate-500 uppercase font-bold tracking-widest flex items-center gap-2">
                                                <Icon name="Zap" size={12} className="text-slate-400" /> Cognitive Symbol
                                            </label>
                                            <div className="flex flex-wrap gap-2 mb-2">
                                                {quickEmojis.map(e => (
                                                    <button key={e} onClick={() => updateNodeData('emoji', e)} 
                                                        className={`w-8 h-8 flex items-center justify-center rounded-lg bg-white/5 hover:bg-white/10 transition-all text-base quick-emoji ${nodesData[getNodeKey(selectedNode.sIdx, selectedNode.nIdx)]?.emoji === e ? 'ring-2 ring-indigo-500 bg-white/10' : ''}`}
                                                    >
                                                        {e}
                                                    </button>
                                                ))}
                                                <button onClick={() => updateNodeData('emoji', '')} className="text-[9px] text-slate-500 uppercase font-bold px-2 hover:text-red-400 transition-colors">Clear</button>
                                            </div>
                                            <input type="text" maxLength="2" 
                                                value={nodesData[getNodeKey(selectedNode.sIdx, selectedNode.nIdx)]?.emoji || ""} 
                                                onChange={(e) => updateNodeData('emoji', e.target.value)}
                                                className="bg-black/20 border border-white/5 rounded-lg p-2 text-center text-xl focus:ring-1 ring-indigo-500 outline-none text-white w-full" placeholder="Or paste emoji here..." />
                                        </div>

                                        <div className="flex flex-col gap-2">
                                            <label className="text-[10px] text-slate-500 uppercase font-bold tracking-widest ml-1">Cognitive Concept</label>
                                            <input type="text" value={nodesData[getNodeKey(selectedNode.sIdx, selectedNode.nIdx)]?.concept || ""} 
                                                onChange={(e) => updateNodeData('concept', e.target.value)}
                                                className="bg-white/5 border border-white/10 rounded-xl p-4 focus:ring-1 ring-indigo-500 outline-none text-white transition-all font-medium" placeholder="Enter core idea..." />
                                        </div>

                                        <div className="flex flex-col gap-4 py-2 border-y border-white/5">
                                            <div className="flex items-center justify-between">
                                                <h3 className="text-[10px] text-indigo-400 uppercase font-bold tracking-[0.2em]">Linked Knowledge</h3>
                                                <span className="text-[9px] text-slate-300 uppercase font-mono">{connections.filter(c => c.includes(getNodeKey(selectedNode.sIdx, selectedNode.nIdx))).length} Threads</span>
                                            </div>
                                            <div className="flex flex-col gap-2">
                                                {(() => {
                                                    const nodeKey = getNodeKey(selectedNode.sIdx, selectedNode.nIdx);
                                                    const myConns = connections.filter(c => c.includes(nodeKey));
                                                    const customOrder = nodesData[nodeKey]?.connectionOrder || [];
                                                    
                                                    const sortedConns = [...myConns].sort((a, b) => {
                                                        const idxA = customOrder.indexOf(a);
                                                        const idxB = customOrder.indexOf(b);
                                                        if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                                                        if (idxA !== -1) return -1;
                                                        if (idxB !== -1) return 1;
                                                        return 0;
                                                    });

                                                    return sortedConns.map((conn, idx) => {
                                                        const otherKey = conn.split(':').find(k => k !== nodeKey);
                                                        const [oSIdx, oNIdx] = otherKey.split('-').map(Number);
                                                        const otherData = nodesData[otherKey];
                                                        const otherSection = sections.find(s => s.id === oSIdx);
                                                        
                                                        return (
                                                            <div 
                                                                key={conn}
                                                                draggable="true"
                                                                onDragStart={(e) => handleCardDragStart(e, idx)}
                                                                onDragOver={(e) => handleCardDragOver(e, idx)}
                                                                onDragLeave={() => setDragOverCardIndex(null)}
                                                                onDrop={(e) => handleCardDrop(e, idx, sortedConns, nodeKey)}
                                                                className={`flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/10 hover:border-indigo-500/30 transition-all group/link overflow-hidden shadow-sm relative ${dragOverCardIndex === idx ? 'card-drag-over' : ''} ${draggedCardIndex === idx ? 'opacity-20' : ''}`}
                                                            >
                                                                <div className="flex flex-col gap-1 overflow-hidden flex-1">
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="shrink-0 flex items-center justify-center w-3">
                                                                            {otherData?.emoji ? <span className="text-[10px]">{otherData.emoji}</span> : <div className={`w-1.5 h-1.5 rounded-full ${otherSection.dot}`} />}
                                                                        </div>
                                                                        <span className="text-[11px] text-cyan-400 uppercase font-bold tracking-tight truncate">{sectionTitles[oSIdx]} â€¢ #{getGlobalIndex(oSIdx, oNIdx)}</span>
                                                                    </div>
                                                                    <div className="text-slate-200 text-sm font-medium italic truncate leading-tight">
                                                                        {otherData?.concept || "Unmapped Node"}
                                                                    </div>
                                                                </div>
                                                                
                                                                <div className="flex items-center gap-1 opacity-0 group-hover/link:opacity-100 transition-opacity ml-2">
                                                                    <div className="p-1 cursor-grab active:cursor-grabbing text-slate-500 hover:text-indigo-400">
                                                                        <Icon name="GripVertical" size={14} />
                                                                    </div>
                                                                    <button onClick={(e) => { e.stopPropagation(); removeConnection(conn); }} className="p-1.5 text-red-400/30 hover:text-red-500 transition-all bg-red-500/5 rounded-lg">
                                                                        <Icon name="Trash2" size={14} />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        );
                                                    });
                                                })()}
                                                
                                                {connections.filter(c => c.includes(getNodeKey(selectedNode.sIdx, selectedNode.nIdx))).length === 0 && (
                                                    <div className="text-center py-4 text-slate-700 text-[9px] uppercase tracking-wider italic border border-dashed border-white/5 rounded-xl">No active connections</div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="flex flex-col gap-2 mt-2">
                                            <label className="text-[10px] text-slate-500 uppercase font-bold tracking-widest ml-1">Citation</label>
                                            <input type="text" value={nodesData[getNodeKey(selectedNode.sIdx, selectedNode.nIdx)]?.citation || ""} 
                                                onChange={(e) => updateNodeData('citation', e.target.value)}
                                                className="bg-white/5 border border-white/10 rounded-xl p-4 focus:ring-1 ring-indigo-500 outline-none text-white transition-all" placeholder="e.g. Smith (2024)" />
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <label className="text-[10px] text-slate-500 uppercase font-bold tracking-widest ml-1">Notes</label>
                                            <textarea value={nodesData[getNodeKey(selectedNode.sIdx, selectedNode.nIdx)]?.notes || ""} 
                                                onChange={(e) => updateNodeData('notes', e.target.value)}
                                                className="bg-white/5 border border-white/10 rounded-xl p-4 h-48 resize-none focus:ring-1 ring-indigo-500 outline-none text-slate-300 text-sm transition-all" placeholder="Describe the connection..." />
                                        </div>

                                        <button onClick={() => setLinkingNode(getNodeKey(selectedNode.sIdx, selectedNode.nIdx))} 
                                            className={`py-4 rounded-xl font-bold text-xs tracking-widest transition-all ${linkingNode === getNodeKey(selectedNode.sIdx, selectedNode.nIdx) ? 'bg-emerald-500 text-black shadow-[0_0_20px_rgba(16,185,129,0.3)]' : 'bg-indigo-600 text-white shadow-[0_0_20px_rgba(79,70,229,0.2)] hover:scale-[1.02] hover:bg-indigo-500'}`}>
                                            {linkingNode ? "PICK TARGET NODE..." : "ATTACH LOGICAL THREAD"}
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex-1 flex flex-col items-center justify-center text-slate-600 text-xs uppercase tracking-widest gap-4 opacity-50">
                                    <Icon name="Brain" size={32} className="text-slate-400" />
                                    Select a node to inspect
                                </div>
                            )}
                        </aside>
                    </main>

                    {showAuthModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-in fade-in duration-300">
                            <div className="w-full max-w-sm bg-[#0a0a0f] border border-white/10 rounded-[2.5rem] p-10 shadow-2xl space-y-8 relative">
                                <button onClick={() => { setShowAuthModal(false); setErrorMessage(null); }} className="absolute top-6 right-6 text-slate-500 hover:text-white">
                                    <Icon name="X" size={20} />
                                </button>
                                <div className="text-center space-y-2">
                                    <h3 className="text-2xl font-thin tracking-tight text-white">{isRegistering ? 'Create Thesis Account' : 'Cloud Login'}</h3>
                                    <p className="text-xs text-slate-500 uppercase tracking-widest text-center">Sync your research anywhere.</p>
                                </div>
                                {errorMessage && <div className="bg-red-500/10 border border-red-500/30 text-red-400 text-[10px] p-3 rounded-xl leading-relaxed">{errorMessage}</div>}
                                <form onSubmit={handleEmailAuth} className="space-y-4">
                                    <div className="space-y-1">
                                        <label className="text-[9px] text-slate-500 uppercase tracking-widest font-bold ml-1">Email</label>
                                        <input required type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-1 focus:ring-indigo-500/50" placeholder="your@email.com" />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[9px] text-slate-500 uppercase tracking-widest font-bold ml-1">Password</label>
                                        <input required type="password" minLength="6" value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-1 focus:ring-indigo-500/50" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
                                    </div>
                                    <button type="submit" disabled={authLoading} className="w-full py-4 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold text-sm transition-all shadow-lg flex items-center justify-center gap-3">
                                        {authLoading ? <Icon name="Loader2" size={16} className="animate-spin" /> : (isRegistering ? 'Register & Sync' : 'Login & Sync')}
                                    </button>
                                </form>
                                <div className="text-center">
                                    <button type="button" onClick={() => { setIsRegistering(!isRegistering); setErrorMessage(null); }} className="text-[10px] text-slate-500 hover:text-indigo-400 uppercase font-bold tracking-widest transition-colors underline underline-offset-4">
                                        {isRegistering ? 'Back to Login' : 'Need a permanent account? Register'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
